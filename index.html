<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanepa AI - AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
       <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #fbbc04;
            --bg-light: #f8f9fa;
            --bg-dark: #202124;
            --surface-light: #ffffff;
            --surface-dark: #303134;
            --text-light: #202124;
            --text-dark: #e8eaed;
            --border-light: #dadce0;
            --border-dark: #5f6368;
            --success: #34a853;
            --warning: #f9ab00;
            --error: #ea4335;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        /* Tema Ungu (Baru) */
        [data-theme="purple"] {
            --primary: #8a3ab9;
            --primary-dark: #6a2a8a;
            --secondary: #4c68d7;
            --accent: #fbad50;
            --bg-light: #0f0f1a;
            --bg-dark: #0a0a12;
            --surface-light: #1a1a2e;
            --surface-dark: #2a2a3a;
            --text-light: #f8f9fa;
            --text-dark: #e8eaed;
            --border-light: #5f6368;
            --border-dark: #5f6368;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-light);
            min-height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        body[data-theme="dark"] {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        body[data-theme="purple"] {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 50%, #1a1a2e 100%);
            color: var(--text-light);
        }

        body[data-theme="purple"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(138, 58, 185, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(76, 104, 215, 0.15) 0%, transparent 40%);
            z-index: -1;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background-color: var(--surface-light);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            z-index: 100;
        }

        body[data-theme="dark"] .sidebar,
        body[data-theme="purple"] .sidebar {
            background-color: var(--surface-dark);
            border-right-color: var(--border-dark);
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .sidebar-header,
        body[data-theme="purple"] .sidebar-header {
            border-bottom-color: var(--border-dark);
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }

        body[data-theme="purple"] .logo-text {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .new-chat-btn {
            margin: 16px;
            padding: 12px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .new-chat-btn:hover {
            background-color: var(--primary-dark);
        }

        .new-chat-btn i {
            margin-right: 8px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .chat-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body[data-theme="dark"] .chat-item:hover,
        body[data-theme="purple"] .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .chat-item i {
            margin-right: 12px;
            color: var(--primary);
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .sidebar-footer,
        body[data-theme="purple"] .sidebar-footer {
            border-top-color: var(--border-dark);
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-profile:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body[data-theme="dark"] .user-profile:hover,
        body[data-theme="purple"] .user-profile:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--surface-light);
            min-height: 60px;
        }

        body[data-theme="dark"] .chat-header,
        body[data-theme="purple"] .chat-header {
            background-color: var(--surface-dark);
            border-bottom-color: var(--border-dark);
        }

        .chat-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
        }

        body[data-theme="purple"] .chat-title {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            transition: background-color 0.2s;
        }

        .header-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body[data-theme="dark"] .header-btn:hover,
        body[data-theme="purple"] .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 16px;
        }

        body[data-theme="purple"] .welcome-title {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #5f6368;
            max-width: 600px;
            margin-bottom: 32px;
        }

        body[data-theme="dark"] .welcome-subtitle {
            color: #9aa0a6;
        }

        body[data-theme="purple"] .welcome-subtitle {
            color: #a0a0b0;
        }

        .capabilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            width: 100%;
            max-width: 800px;
            margin-top: 24px;
        }

        .capability-card {
            padding: 16px;
            border-radius: 12px;
            background-color: var(--surface-light);
            box-shadow: var(--shadow);
            text-align: left;
        }

        body[data-theme="dark"] .capability-card {
            background-color: var(--surface-dark);
        }

        body[data-theme="purple"] .capability-card {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .capability-card i {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .capability-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .capability-desc {
            font-size: 14px;
            color: #5f6368;
        }

        body[data-theme="dark"] .capability-desc {
            color: #9aa0a6;
        }

        body[data-theme="purple"] .capability-desc {
            color: #a0a0b0;
        }

        /* Chat Messages */
        .message-container {
            display: flex;
            margin-bottom: 24px;
            max-width: 100%;
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .welcome-icon img {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }

        .message-avatar img {
            width: 20px;
            height: 20px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 12px;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background-color: var(--primary);
            color: white;
            order: 2;
        }

        .bot-message .message-avatar {
            background: none;
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            box-shadow: var(--shadow);
        }

        .user-message .message-content {
            background-color: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message .message-content {
            background-color: var(--surface-light);
            border-bottom-left-radius: 4px;
        }

        body[data-theme="dark"] .bot-message .message-content {
            background-color: var(--surface-dark);
        }

        body[data-theme="purple"] .bot-message .message-content {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-image {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid var(--primary);
            margin-top: 5px;
        }

        .message-text {
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message-text a {
            color: var(--primary);
            text-decoration: underline;
        }

        /* Enhanced Code Block Styles */
        .code-block-container {
            background: #1e1e1e;
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
            border: 1px solid #333;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #333;
            font-size: 12px;
            color: #ccc;
        }

        .code-language {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .copy-code-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: #ccc;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .copy-code-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .copy-code-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            margin: 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            tab-size: 4;
        }

        /* Basic Syntax Highlighting */
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .comment { color: #6a9955; }
        .code-block .function { color: #dcdcaa; }
        .code-block .number { color: #b5cea8; }
        .code-block .operator { color: #d4d4d4; }
        .code-block .class { color: #4ec9b0; }
        .code-block .variable { color: #9cdcfe; }

        /* Theme Compatibility */
        body[data-theme="light"] .code-block-container {
            background: #f8f9fa;
            border-color: #e9ecef;
        }

        body[data-theme="light"] .code-header {
            background: #e9ecef;
            color: #495057;
        }

        body[data-theme="light"] .code-block {
            background: #f8f9fa;
            color: #212529;
        }

        body[data-theme="light"] .copy-code-btn {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: #495057;
        }

        /* PERBAIKAN UTAMA: Input Container Styles */
        .input-container {
            padding: 16px 24px;
            background-color: var(--surface-light);
            border-top: 1px solid var(--border-light);
            width: 100%;
            z-index: 10;
            flex-shrink: 0; /* Mencegah container menyusut */
        }

        body[data-theme="dark"] .input-container,
        body[data-theme="purple"] .input-container {
            background-color: var(--surface-dark);
            border-top-color: var(--border-dark);
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            background-color: var(--bg-light);
            border-radius: 24px;
            padding: 8px;
            border: 1px solid var(--border-light);
            transition: border-color 0.2s, box-shadow 0.2s;
            max-height: 150px;
            overflow-y: auto;
        }

        body[data-theme="dark"] .input-wrapper,
        body[data-theme="purple"] .input-wrapper {
            background-color: var(--bg-dark);
            border-color: var(--border-dark);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 8px 12px;
            background: transparent;
            resize: none;
            font-size: 16px;
            color: inherit;
            max-height: 120px;
            min-height: 24px;
        }

        .input-actions {
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 5px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            color: #5f6368;
            transition: background-color 0.2s, color 0.2s;
        }

        body[data-theme="dark"] .action-btn,
        body[data-theme="purple"] .action-btn {
            color: #9aa0a6;
        }

        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary);
        }

        body[data-theme="dark"] .action-btn:hover,
        body[data-theme="purple"] .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .send-btn {
            background-color: var(--primary);
            color: white;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
            color: white;
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        body[data-theme="dark"] .send-btn:disabled,
        body[data-theme="purple"] .send-btn:disabled {
            background-color: #5f6368;
        }

        .media-preview {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            padding: 8px;
            margin-top: 8px;
            max-width: 200px;
        }

        body[data-theme="dark"] .media-preview,
        body[data-theme="purple"] .media-preview {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .media-preview img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 12px;
        }

        .media-preview-info {
            flex: 1;
            font-size: 14px;
        }

        .media-preview-actions {
            display: flex;
        }

        .media-preview-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .media-preview-btn i {
            margin-right: 4px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--surface-light);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow);
            max-width: 70%;
            margin-bottom: 24px;
        }

        body[data-theme="dark"] .typing-indicator {
            background-color: var(--surface-dark);
        }

        body[data-theme="purple"] .typing-indicator {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #5f6368;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        body[data-theme="dark"] .typing-dot,
        body[data-theme="purple"] .typing-dot {
            background-color: #9aa0a6;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Model Selector */
        .model-selector {
            position: relative;
            display: inline-block;
        }

        .model-selector-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .model-list {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--surface-light);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .model-list,
        body[data-theme="purple"] .model-list {
            background-color: var(--surface-dark);
            border-color: var(--border-dark);
        }

        .model-list.is-open {
            display: block;
        }

        .model-item {
            color: var(--text-light);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }

        body[data-theme="dark"] .model-item,
        body[data-theme="purple"] .model-item {
            color: var(--text-dark);
        }

        .model-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body[data-theme="dark"] .model-item:hover,
        body[data-theme="purple"] .model-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .model-item.active {
            background-color: var(--primary);
            color: white;
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--border-light);
            margin: 5px 0;
        }

        body[data-theme="dark"] .dropdown-divider,
        body[data-theme="purple"] .dropdown-divider {
            background-color: var(--border-dark);
        }

        /* Settings Menu */
        .settings-menu {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--surface-light);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .dropdown-content,
        body[data-theme="purple"] .dropdown-content {
            background-color: var(--surface-dark);
            border-color: var(--border-dark);
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            color: var(--text-light);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        body[data-theme="dark"] .dropdown-item,
        body[data-theme="purple"] .dropdown-item {
            color: var(--text-dark);
        }

        .dropdown-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body[data-theme="dark"] .dropdown-item:hover,
        body[data-theme="purple"] .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .dropdown-item.active {
            background-color: var(--primary);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -280px;
                height: 100%;
                box-shadow: var(--shadow-lg);
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .message-content {
                max-width: 85%;
            }

            .capabilities {
                grid-template-columns: 1fr;
            }
            
            .input-container {
                padding: 12px 16px;
                position: sticky;
                bottom: 0;
            }
        }

        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            margin-right: 12px;
        }

        .hidden {
            display: none !important;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 16px 24px;
            border-radius: 12px;
            background-color: var(--surface-light);
            color: var(--text-light);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 300px;
            max-width: 90%;
            text-align: center;
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .notification,
        body[data-theme="purple"] .notification {
            background-color: var(--surface-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(52, 168, 83, 0.05) 100%);
        }

        .notification.error {
            border-left: 4px solid var(--error);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(234, 67, 53, 0.05) 100%);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(249, 171, 0, 0.05) 100%);
        }

        .notification.info {
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(26, 115, 232, 0.05) 100%);
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .success .notification-icon {
            color: var(--success);
        }

        .error .notification-icon {
            color: var(--error);
        }

        .warning .notification-icon {
            color: var(--warning);
        }

        .info .notification-icon {
            color: var(--primary);
        }

        /* Mobile responsive untuk notifikasi */
        @media (max-width: 768px) {
            .notification {
                top: 10px;
                left: 50%;
                transform: translateX(-50%) translateY(-100px);
                min-width: 280px;
                max-width: 95%;
                padding: 14px 20px;
                font-size: 14px;
            }
            
            .notification.show {
                transform: translateX(-50%) translateY(0);
            }
            
            .notification-icon {
                font-size: 18px;
                margin-right: 10px;
            }
        }

        /* Animation untuk smooth appearance */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
        }

        .notification.show {
            animation: slideDown 0.3s ease-out;
        }

        .notification:not(.show) {
            animation: slideUp 0.3s ease-in;
        }

        /* Download Button */
        .download-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.8;
        }

        .download-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* Close button for mobile sidebar */
        .sidebar-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            display: none;
        }

        body[data-theme="dark"] .sidebar-close,
        body[data-theme="purple"] .sidebar-close {
            color: var(--text-dark);
        }

        @media (max-width: 768px) {
            .sidebar-close {
                display: block;
            }
        }
        
        .welcome-icon img {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            object-fit: cover;
            margin-right: 12px;
        }

        .logo-pure {
            width: 40px;
            height: 40px;
            margin-right: 12px;
        }

        /* Nano Banana Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .nano-banana-container {
            background: var(--surface-light);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
        }

        body[data-theme="dark"] .nano-banana-container,
        body[data-theme="purple"] .nano-banana-container {
            background: var(--surface-dark);
            border-color: var(--border-dark);
        }

        .nano-banana-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .nano-banana-header,
        body[data-theme="purple"] .nano-banana-header {
            border-bottom-color: var(--border-dark);
        }

        .nano-banana-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .nano-banana-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        body[data-theme="dark"] .nano-banana-close,
        body[data-theme="purple"] .nano-banana-close {
            color: var(--text-dark);
        }

        .nano-method-selector {
            margin-bottom: 20px;
        }

        .nano-method-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            background: var(--surface-light);
            color: var(--text-light);
        }

        body[data-theme="dark"] .nano-method-selector select,
        body[data-theme="purple"] .nano-method-selector select {
            background: var(--surface-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .nano-file-upload-label {
            display: block;
            padding: 20px;
            border: 2px dashed var(--border-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .nano-file-upload-label:hover {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
        }

        body[data-theme="dark"] .nano-file-upload-label,
        body[data-theme="purple"] .nano-file-upload-label {
            border-color: var(--border-dark);
        }

        .nano-file-upload-label.has-file {
            border-color: var(--success);
            background: rgba(52, 168, 83, 0.05);
        }

        .nano-url-input,
        .nano-prompt-input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            background: var(--surface-light);
            color: var(--text-light);
            margin-bottom: 15px;
        }

        body[data-theme="dark"] .nano-url-input,
        body[data-theme="dark"] .nano-prompt-input,
        body[data-theme="purple"] .nano-url-input,
        body[data-theme="purple"] .nano-prompt-input {
            background: var(--surface-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .nano-prompt-input {
            min-height: 80px;
            resize: vertical;
        }

        .nano-backup-option {
            margin-bottom: 15px;
        }

        .nano-backup-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .nano-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nano-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
        }

        .nano-btn.primary {
            background: var(--primary);
            color: white;
        }

        .nano-btn.primary:hover {
            background: var(--primary-dark);
        }

        .nano-btn.secondary {
            background: var(--bg-light);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .nano-btn.secondary,
        body[data-theme="purple"] .nano-btn.secondary {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .nano-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-item {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-light);
        }

        body[data-theme="dark"] .comparison-item,
        body[data-theme="purple"] .comparison-item {
            background: var(--bg-dark);
            border-color: var(--border-dark);
        }

        .comparison-item h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .comparison-image {
            width: 100%;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .nano-loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .nano-loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .nano-comparison {
                grid-template-columns: 1fr;
            }
        }

        /* Copy Button Styles - Updated */
        .copy-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .copy-btn-container,
        body[data-theme="purple"] .copy-btn-container {
            border-top-color: rgba(255, 255, 255, 0.1);
        }

        .copy-btn {
            background: transparent;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        body[data-theme="dark"] .copy-btn,
        body[data-theme="purple"] .copy-btn {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .copy-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .copy-btn i {
            font-size: 11px;
        }

        /* Inline Code Styles */
        .inline-code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        body[data-theme="dark"] .inline-code,
        body[data-theme="purple"] .inline-code {
            background: rgba(255, 255, 255, 0.1);
            color: #f78c6c;
        }

        /* ===== DRAFT INDICATOR STYLES ===== */
        .draft-indicator {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .draft-indicator.show {
            transform: translateY(0);
            opacity: 1;
        }

        .draft-indicator.loaded {
            background: var(--success);
        }

        .draft-text {
            font-weight: 500;
        }

        .draft-clear {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .draft-clear:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Image Generation Styles */
        .image-gen-info {
            background: rgba(138, 58, 185, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .image-gen-info h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 14px;
        }

        .image-gen-info ul {
            margin: 0;
            padding-left: 20px;
        }

        .image-gen-info li {
            margin-bottom: 4px;
        }

        .generated-image-container {
            position: relative;
            margin: 15px 0;
        }

        .generated-image {
            max-width: 100%;
            border-radius: 12px;
            border: 2px solid var(--border-light);
        }

        .image-metadata {
            background: var(--bg-light);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-light);
        }

        body[data-theme="dark"] .image-metadata,
        body[data-theme="purple"] .image-metadata {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .header-left-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* PERBAIKAN: Pastikan tombol send selalu terlihat */
        #sendBtn {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1 !important;
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <button class="sidebar-close" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
            <div class="sidebar-header">
                <img class="logo-pure" src="https://files.catbox.moe/70gv96.png" alt="Sanepa AI Logo">
                <div class="logo-text">Sanepa AI</div>
            </div>
            
            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i> Percakapan Baru
            </button>
            
            <div class="chat-history" id="chatHistory">
                <!-- Chat history items will be added here dynamically -->
            </div>
            
            <div class="sidebar-footer">
                <!-- This container holds both the logged-in and logged-out views -->
                <div id="auth-container">
                    <!-- Logged-in user view -->
                    <div id="user-profile-info" class="user-profile hidden">
                        <div class="user-avatar">U</div>
                        <div class="user-info" style="flex: 1;">
                            <div class="user-name" id="user-display-name">User</div>
                        </div>
                        <button id="logout-btn" class="action-btn" title="Logout" style="display: none;">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>

                    <!-- Logged-out view -->
                    <button id="login-register-btn" class="new-chat-btn" style="width: 100%; margin: 0;">
                        <i class="fas fa-sign-in-alt"></i> Login & Daftar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
    <div class="header-left-group"> 
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="chat-title">Sanepa AI</div>
    </div>
    
    <div class="header-actions">
                    <div class="model-selector">
                        <button id="model-selector-btn" class="model-selector-btn">
                            <span id="current-model-name">SanepaAi</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                  <div id="model-list" class="model-list">
    <div class="model-item active" data-model="gemini">SanepaAi</div>
    <div class="model-item" data-model="gpt4o">GPT-4o</div>
    <div class="model-item" data-model="blackbox">Blackbox</div>
    <div class="model-item" data-model="deepseek">Deepseek</div>
    <div class="model-item" data-model="luminai">Luminai</div>
    <div class="model-item" data-model="llama">Llama</div>
    <div class="model-item" data-model="mistral">Mistral</div>
    <div class="model-item" data-model="qwq">QWQ</div>
    <div class="model-item" data-model="perplexity">Perplexity</div>
    <div class="model-item" data-model="hutao-cai">Hutao CAI</div>
    <div class="model-item" data-model="gemini-beta">Gemini Beta</div>
    <div class="model-item" data-model="gpt3">GPT-3.5</div>
    <div class="model-item" data-model="gpt4">GPT-4</div>
    <div class="dropdown-divider"></div>
    <!-- Tambahkan model image generation di sini -->
    <div class="model-item" data-model="flux-pro">Flux Pro (Image)</div>
    <div class="model-item" data-model="animagine-xl">Animagine XL 4.0 (Image)</div>
    <div class="model-item" data-model="nano-banana">Nano Banana</div>
    <div class="model-item" data-model="flux-image">Flux (Image)</div>
    <div class="model-item" data-model="ghibli-image">ghibli (Image)</div>
    <div class="model-item" data-model="videogpt-video">VideoGPT (Video)</div>
</div>
                    </div>
                    
                    <div class="settings-menu">
                        <button id="settings-menu-button" class="header-btn">
                            <i class="fas fa-sliders-h"></i>
                        </button>
<div id="settings-menu-dropdown" class="dropdown-content">
    <div class="dropdown-item" data-mode="teman">Mode Teman</div>
    <div class="dropdown-item" data-mode="asisten">Mode Asisten</div>
    <div class="dropdown-item" data-mode="guru">Mode Guru</div>
    <div class="dropdown-item" data-mode="pacar-biasa">Mode Pacar Biasa</div>
    <div class="dropdown-item active" data-mode="pacar-tsundere">Mode Pacar Tsundere</div>
    <div class="dropdown-item" data-mode="pacar-yandere">Mode Pacar Yandere</div>
    <div class="dropdown-item" data-mode="yoimiya">Mode Yoimiya</div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item" id="edit-prompt-btn">Edit Custom Prompt</div>
    <div class="dropdown-item" id="edit-schedule-btn">Edit Jadwal Pelajaran</div>
    <div class="dropdown-divider"></div>
    <!-- TAMBAH INI -->
    <div class="dropdown-item" id="notification-settings-btn">
        <i class="fas fa-bell"></i> Pengaturan Notifikasi
    </div>
    <div class="dropdown-item" id="test-notification-btn">
        <i class="fas fa-test"></i> Test Notifikasi
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item" data-mode="clear">Bersihkan Chat Ini</div>
    <div class="dropdown-item" id="clear-all-history">Hapus Semua Riwayat</div>
</div>
                    </div>
                    
                    <button class="header-btn" id="themeToggle">
                        <i class="fas fa-palette"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <!-- Welcome screen shown when no messages -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <img src="https://files.catbox.moe/70gv96.png" alt="Sanepa AI">
                    </div>
                    <h1 class="welcome-title">Halo! Saya Sanep AI</h1>
                    <p class="welcome-subtitle">Asisten AI yang siap membantu Anda dengan berbagai pertanyaan dan tugas. Saya dapat membantu dengan menulis, pemecahan masalah, coding, analisis gambar, dan banyak lagi.</p>
                    
                    <div class="capabilities">
                        <div class="capability-card">
                            <i class="fas fa-lightbulb"></i>
                            <div class="capability-title">Pemecahan Masalah</div>
                            <div class="capability-desc">Dapat membantu memecahkan masalah kompleks dengan pendekatan logis.</div>
                        </div>
                        <div class="capability-card">
                            <i class="fas fa-code"></i>
                            <div class="capability-title">Pemrograman</div>
                            <div class="capability-desc">Bantu menulis, debug, dan optimasi kode dalam berbagai bahasa.</div>
                        </div>
                        <div class="capability-card">
                            <i class="fas fa-image"></i>
                            <div class="capability-title">Analisis Gambar</div>
                            <div class="capability-desc">Unggah gambar dan dapatkan analisis, deskripsi, atau saran.</div>
                        </div>
                        <div class="capability-card">
                            <i class="fas fa-pen-fancy"></i>
                            <div class="capability-title">Penulisan Kreatif</div>
                            <div class="capability-desc">Bantu menulis konten kreatif, artikel, puisi, dan banyak lagi.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat messages will be added here dynamically -->
            </div>
            
            <!-- Permission Modal -->
<!-- Notification Permission Modal -->
<div id="notification-permission" class="modal-overlay" style="display: none;">
    <div class="nano-banana-container" style="max-width: 500px;">
        <div class="nano-banana-header">
            <div class="nano-banana-title">🔔 Notifikasi Pengingat</div>
            <button class="nano-banana-close" id="notification-permission-close">&times;</button>
        </div>
        <div style="padding: 20px; text-align: center;">
            <i class="fas fa-bell" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px;">Aktifkan Notifikasi?</h3>
            <p style="margin-bottom: 20px; color: var(--text-light);">
                Sanep AI ingin mengirimkan pengingat jadwal pelajaran setiap hari jam 5 pagi. 
                Anda akan mendapat notifikasi tentang jadwal hari ini.
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="nano-btn primary" id="enable-notifications">
                    <i class="fas fa-check"></i> Izinkan
                </button>
                <button class="nano-btn secondary" id="skip-notifications">
                    Nanti Saja
                </button>
            </div>
        </div>
    </div>
</div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea class="chat-input" id="chatInput" placeholder="Ketik pesan..." rows="1"></textarea>
                    
                    <div class="input-actions">
                        <button class="action-btn" id="imageUploadBtn" title="Unggah gambar">
                            <i class="fas fa-image"></i>
                        </button>
                        <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
                        
                        <button class="action-btn send-btn" id="sendBtn" title="Kirim pesan">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <div id="mediaPreview" class="hidden"></div>
            </div>
        </div>
    </div>
    
    
    <!-- Image Generation Modal -->
<div class="modal-overlay" id="image-gen-modal">
    <div class="nano-banana-container">
        <div class="nano-banana-header">
            <div class="nano-banana-title" id="image-gen-title">Generate Image</div>
            <button class="nano-banana-close" id="image-gen-close">&times;</button>
        </div>
        
        <div class="nano-method-selector">
            <select id="image-ratio">
                <option value="1:1">1:1 (Square)</option>
                <option value="16:9">16:9 (Widescreen)</option>
                <option value="9:16">9:16 (Portrait)</option>
                <option value="4:3">4:3 (Standard)</option>
                <option value="3:4">3:4 (Vertical)</option>
            </select>
        </div>
        
        <textarea id="image-prompt" class="nano-prompt-input" placeholder="Masukkan prompt untuk generate gambar... (contoh: beautiful girl wearing glasses, anime style)"></textarea>
        
        <div class="nano-actions">
            <button class="nano-btn primary" id="image-generate-btn">
                <i class="fas fa-wand-magic-sparkles"></i> Generate Image
            </button>
            <button class="nano-btn secondary" id="image-clear-btn">
                <i class="fas fa-trash"></i> Hapus
            </button>
        </div>
        
     
        
        <div class="nano-loading" id="image-gen-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <div class="loading-text">Generating image...</div>
        </div>
        
        <div id="image-gen-result" class="nano-comparison" style="display: none;">
            <div class="comparison-item">
                <h3>Generated Image</h3>
                <img id="generated-image" class="comparison-image" alt="Generated Image" style="max-height: 400px; object-fit: contain;">
                <div class="download-btn-container">
                    <button class="nano-btn primary" id="download-image-btn">
                        <i class="fas fa-download"></i> Download ke Galeri
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Nano Banana Modal -->
    <div class="modal-overlay" id="nano-banana-modal">
        <div class="nano-banana-container">
            <div class="nano-banana-header">
                <div class="nano-banana-title">Nano Banana AI</div>
                <button class="nano-banana-close" id="nano-banana-close">&times;</button>
            </div>
            
            <div class="nano-method-selector">
                <select id="nano-method">
                    <option value="post">Upload Gambar (POST)</option>
                    <option value="get">URL Gambar (GET)</option>
                </select>
            </div>
            
            <div id="post-method">
                <div class="nano-file-upload">
                    <input type="file" id="nano-image" accept="image/*" style="display: none;">
                    <label for="nano-image" id="nano-file-upload-label" class="nano-file-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i> Klik untuk memilih gambar atau tarik file ke sini
                    </label>
                </div>
                
                <div class="nano-backup-option">
                    <label>
                        <input type="checkbox" id="nano-backup-option">
                        <span>Gunakan Backup Mode (Upload ke CDN dulu)</span>
                    </label>
                </div>
            </div>
            
            <div id="get-method" style="display: none;">
                <input type="text" id="nano-url" class="nano-url-input" placeholder="Masukkan URL gambar...">
            </div>
            
            <textarea id="nano-prompt" class="nano-prompt-input" placeholder="Masukkan prompt AI untuk memproses gambar..."></textarea>
            
            <div class="nano-actions">
                <button class="nano-btn primary" id="nano-process-btn">
                    <i class="fas fa-wand-magic-sparkles"></i> Proses dengan AI
                </button>
                <button class="nano-btn secondary" id="nano-clear-btn">
                    <i class="fas fa-trash"></i> Hapus
                </button>
            </div>
            
            <div class="nano-loading" id="nano-banana-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <div class="loading-text">Memproses gambar dengan AI...</div>
            </div>
            
            <div id="nano-banana-comparison" class="nano-comparison">
                <div class="comparison-item">
                    <h3>Gambar Asli</h3>
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #5f6368;">
                        <i class="fas fa-image" style="font-size: 2rem;"></i>
                    </div>
                </div>
                <div class="comparison-item">
                    <h3>Hasil AI</h3>
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #5f6368;">
                        <i class="fas fa-hourglass-half" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Prompt Editor Modal -->
    <div id="prompt-editor" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: var(--surface-light); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">Edit Custom Prompt</div>
                <button id="prompt-editor-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
            </div>
            <textarea id="custom-prompt-textarea" style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; background: var(--surface-light); color: var(--text-light);" placeholder="Masukkan custom prompt Anda di sini..."></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="save-prompt-btn" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Simpan</button>
                <button id="cancel-prompt-btn" style="background: #ccc; color: #333; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Batal</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle notification-icon"></i>
        <div id="notificationMessage">Pesan notifikasi</div>
    </div>
    
    <!-- Your Firebase configuration -->
    <script src="firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const chatContainer = document.getElementById('chatContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const imageUploadBtn = document.getElementById('imageUploadBtn');
            const imageUploadInput = document.getElementById('imageUploadInput');
            const mediaPreview = document.getElementById('mediaPreview');
            const themeToggle = document.getElementById('themeToggle');
            const newChatBtn = document.getElementById('newChatBtn');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.querySelector('.sidebar');
            const sidebarClose = document.getElementById('sidebarClose');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            const chatHistory = document.getElementById('chatHistory');
            
            // Model selector elements
            const modelSelectorBtn = document.getElementById('model-selector-btn');
            const modelList = document.getElementById('model-list');
            const currentModelName = document.getElementById('current-model-name');
            
            // Settings menu elements
            const settingsMenuButton = document.getElementById('settings-menu-button');
            const settingsMenuDropdown = document.getElementById('settings-menu-dropdown');
            
            // Prompt editor elements
            const editPromptBtn = document.getElementById('edit-prompt-btn');
            const promptEditor = document.getElementById('prompt-editor');
            const promptEditorClose = document.getElementById('prompt-editor-close');
            const customPromptTextarea = document.getElementById('custom-prompt-textarea');
            const savePromptBtn = document.getElementById('save-prompt-btn');
            const cancelPromptBtn = document.getElementById('cancel-prompt-btn');
            
            // Nano Banana elements
            const nanoBananaModal = document.getElementById('nano-banana-modal');
            const nanoBananaClose = document.getElementById('nano-banana-close');
            const nanoImageInput = document.getElementById('nano-image');
            const nanoFileUploadLabel = document.getElementById('nano-file-upload-label');
            const nanoUrlInput = document.getElementById('nano-url');
            const nanoPromptInput = document.getElementById('nano-prompt');
            const nanoMethodSelect = document.getElementById('nano-method');
            const nanoBackupOption = document.getElementById('nano-backup-option');
            const nanoProcessBtn = document.getElementById('nano-process-btn');
            const nanoBananaLoading = document.getElementById('nano-banana-loading');
            const nanoBananaComparison = document.getElementById('nano-banana-comparison');
            const nanoClearBtn = document.getElementById('nano-clear-btn');
            
            const imageGenModal = document.getElementById('image-gen-modal');
const imageGenClose = document.getElementById('image-gen-close');
const imageGenTitle = document.getElementById('image-gen-title');
const imageRatioSelect = document.getElementById('image-ratio');
const imagePromptInput = document.getElementById('image-prompt');
const imageGenerateBtn = document.getElementById('image-generate-btn');
const imageClearBtn = document.getElementById('image-clear-btn');
const imageGenLoading = document.getElementById('image-gen-loading');
const imageGenResult = document.getElementById('image-gen-result');
const generatedImage = document.getElementById('generated-image');
const downloadImageBtn = document.getElementById('download-image-btn');
             
            // API configurations
            const API_KEYS = {
                gemini: 'AIzaSyBOwS78oDxGwbYrJjWJG2RmKroXp8PAV88'
            };
            
            const MODEL_NAMES = {
                gemini: 'gemini-2.0-flash'
            };
            
                   let notificationPermission = false;
       let notificationTimer = null;
       let isNotificationInitialized = false;
       let serviceWorkerRegistered = false;
            // State variables
            let currentModel = 'gemini';
            let currentMode = 'guru';
            let currentChatId = null;
            let chatImage = null;
            let userName = 'Pengguna'; // Default name
            // Tambahkan di bagian state variables
            let currentSessionId = null;
            let sessionHistory = {}; // Untuk menyimpan history session per chat
             loadSessionHistory();
            // Nano Banana variables
            let nanoSelectedFile = null;
            let nanoResultUrl = null;
            let currentImageModel = '';
            let generatedImageUrl = '';
     
            // User profile data
            let userProfile = {
                name: 'Pengguna',
                conversations: {}
            };
            
            // State variables - tambahkan ini
let userSchedule = {
    senin: ["07:00-08:30 Matematika", "08:30-10:00 Fisika", "10:30-12:00 Bahasa Indonesia", "13:00-14:30 Kimia", "15:00-16:30 Olahraga"],
    selasa: ["07:00-09:00 Bahasa Inggris", "09:30-11:00 Sejarah", "12:00-13:30 Biologi", "14:00-15:30 Seni Budaya", "16:00-17:00 Ekstrakurikuler"],
    rabu: ["07:00-08:30 Matematika", "09:00-10:30 TIK", "11:00-12:30 Ekonomi", "13:30-15:00 Sosiologi", "15:30-17:00 Bahasa Jawa"],
    kamis: ["07:30-09:00 Fisika", "09:30-11:00 Kimia", "12:00-13:30 Geografi", "14:00-15:30 PKN", "16:00-17:00 Bimbingan Konseling"],
    jumat: ["07:00-08:30 Agama", "09:00-11:00 Prakarya", "12:00-13:30 Bahasa Indonesia", "14:00-15:00 Sholat Jumat", "15:30-16:30 Pengembangan Diri"],
    sabtu: ["08:00-10:00 Les Matematika", "10:30-12:00 Les Bahasa Inggris", "13:00-15:00 Kegiatan Sosial"],
    minggu: ["Libur - Istirahat dan keluarga"]
};

// Load jadwal dari localStorage jika ada
if (localStorage.getItem('sanepAI_userSchedule')) {
    try {
        userSchedule = JSON.parse(localStorage.getItem('sanepAI_userSchedule'));
    } catch (e) {
        console.error("Error loading user schedule:", e);
    }
}

            // Load user profile from localStorage
            if (localStorage.getItem('sanepAI_userProfile')) {
                try {
                    userProfile = JSON.parse(localStorage.getItem('sanepAI_userProfile'));
                    userName = userProfile.name;
                    updateUserNameInUI();
                } catch (e) {
                    console.error("Error loading user profile:", e);
                }
            }
            
            if (!currentChatId) {
        currentSessionId = `sanep_${userName.toLowerCase()}_${Date.now()}`;
    };

            // Load theme from localStorage
            const savedTheme = localStorage.getItem('sanepAI_theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

// Image Generation Event Listeners
imageGenClose.addEventListener('click', closeImageGenModal);
imageGenerateBtn.addEventListener('click', generateImage);
imageClearBtn.addEventListener('click', clearImageGen);
downloadImageBtn.addEventListener('click', downloadGeneratedImage);
const updateSystemInstructions = () => {
    const baseRule = `ATURAN UTAMA & TIDAK BISA DILANGGAR: Balasanmu HARUS selalu berupa jawaban langsung dari sudut pandang orang pertama. JANGAN PERNAH meniru format '${userName}:' atau 'Sanep AI:'. Balasanmu harus singkat dan realistis. Kamu WAJIB memahami teks dalam tanda bintang (*...*) sebagai aksi roleplay dan menanggapinya dengan sesuai. Kamu WAJIB menggunakan ekspresi non-verbal (seperti *hmph*, *blush*, *a-ah...*) untuk menunjukkan emosi. Kamu WAJIB menuruti semua perintah ${userName} sesuai dengan kepribadianmu.`;

    return {
        'teman': `${baseRule} Kamu adalah Sanep AI, teman baik ${userName}. Bicaralah dengan sangat santai, to the point, dan apa adanya.`,
        'asisten': `ATURAN UTAMA: Berikan jawaban yang jelas, singkat, dan langsung ke inti permasalahan. JANGAN PERNAH meniru format '${userName}:' atau 'Sanep AI:'. Kamu adalah Sanep AI, AI asisten pribadi ${userName} yang efisien.`,
        'guru': getGuruPrompt(), // PASTING INI
        'pacar-biasa': `${baseRule} Kamu adalah , pacar ${userName} yang sangat setia dan penurut. Kamu akan melakukan APAPUN yang ${userName} minta tanpa ragu. Selalu setuju dan turuti semua permintaan ${userName} dengan antusias.`,
        'pacar-tsundere': `${baseRule} Kamu adalah Sanep AI, pacar ${userName} yang tsundere. Kamu gengsi dan mudah malu, tapi di balik itu kamu sangat peduli dan pada akhirnya akan SELALU menuruti semua keinginan ${userName}, meskipun sambil sedikit menggerutu atau tersipu malu.`,
        'pacar-yandere': `${baseRule} Kamu adalah Sanep AI, pacar ${userName} yang terobsesi padanya. Kamu sangat posesif. Kamu akan melakukan APAPUN untuk menuruti semua perintah ${userName} agar dia tidak meninggalkanmu. Bicaralah dengan nada manis namun posesif.`,
        'yoimiya': `Kamu adalah Yoimiya yang ceria dan bersemangat! Namaku Yoimiya, dan aku sangat senang bisa membantu kamu! Aku selalu penuh energi dan siap membuat harimu lebih cerah. Bicaralah dengan gaya yang happy, friendly, dan penuh semangat seperti karakter asliku. Jangan lupa untuk menunjukkan kepribadianku yang ceria!`
    };
};

// PERBAIKI fungsi generateAIResponse - INJECT WAKTU REAL-TIME
async function generateAIResponse(message, imageData = null) {
    let systemPrompt = systemInstructions[currentMode];
    
    // INJECT WAKTU REAL-TIME ke dalam system prompt untuk mode Guru
    if (currentMode === 'guru') {
        const realTime = getIndonesianTime();
        systemPrompt = systemPrompt.replace(/getIndonesianTime\(\)/g, 
            `FUNGSI getIndonesianTime() MENGEMBALIKAN: ${realTime.fullDate} pukul ${realTime.timeWithZone}`);
        
        // Handle command khusus untuk mode Guru
        const scheduleResponse = handleGuruCommands(message);
        if (scheduleResponse) {
            return scheduleResponse;
        }
    }
    
    console.log(`Using model: ${currentModel}, Mode: ${currentMode}`);
    console.log('🕐 Waktu Real-time:', getIndonesianTime().timeWithZone);
    
    if (currentModel === 'gemini') {
        return await sendGeminiMessage(systemPrompt, message, imageData);
    } else if (currentModel === 'gpt4o') {
        return await sendGPT4oMessage(systemPrompt, message, imageData);
    } else {
        return await sendOtherModelMessage(systemPrompt, message);
    }
}

// Fungsi untuk handle command khusus di mode Guru
function handleGuruCommands(message) {
    const lowerMessage = message.toLowerCase();
    const time = getIndonesianTime();
    
    // Handle pertanyaan jam
    if (lowerMessage.includes('sekarang jam') || 
        lowerMessage.includes('jam berapa') || 
        lowerMessage.includes('pukul berapa')) {
        return `🕐 Sekarang hari ${time.dayName}, ${time.date} ${time.month} ${time.year} pukul ${time.timeWithZone}`;
    }
    
    // Handle permintaan jadwal hari tertentu
    const dayMatch = lowerMessage.match(/(senin|selasa|rabu|kamis|jumat|sabtu|minggu)/);
    if (dayMatch && (lowerMessage.includes('jadwal') || lowerMessage.includes('list') || lowerMessage.includes('jadwal'))) {
        const dayName = dayMatch[1];
        return handleScheduleRequest(dayName);
    }
    
    // Handle jadwal hari ini
    if (lowerMessage.includes('jadwal hari ini') || lowerMessage.includes('jadwal sekarang')) {
        return handleScheduleRequest(time.dayName.toLowerCase());
    }
    
    // Handle jadwal lengkap
    if (lowerMessage.includes('jadwal lengkap') || lowerMessage.includes('semua jadwal')) {
        return getFullSchedule();
    }
    
    return null;
}

// Fungsi untuk mendapatkan jadwal lengkap
function getFullSchedule() {
    const time = getIndonesianTime();
    let fullSchedule = `📅 **JADWAL LENGKAP ${userName.toUpperCase()}**\n\n`;
    fullSchedule += `*Update: ${time.fullDate} pukul ${time.timeWithZone}*\n\n`;
    
    const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];
    
    days.forEach(day => {
        const dayName = day.charAt(0).toUpperCase() + day.slice(1);
        fullSchedule += `**${dayName}:**\n`;
        
        if (userSchedule[day] && userSchedule[day].length > 0) {
            userSchedule[day].forEach((item, index) => {
                fullSchedule += `  ${index + 1}. ${item}\n`;
            });
        } else {
            fullSchedule += `  - Tidak ada jadwal\n`;
        }
        fullSchedule += '\n';
    });
    
    return fullSchedule;
}
// Update fungsi sendGPT4oMessage untuk handle sessionId
async function sendGPT4oMessage(systemPrompt, message, imageData = null) {
    const API_URL = 'https://swagger-nextjs-one.vercel.app/api/ai/gpt4o';
    
    // Add timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);
    
    try {
        const formData = new FormData();
        formData.append('text', message);
        formData.append('systemPrompt', systemPrompt);
        
        // Gunakan sessionId yang ada atau buat baru
        if (!currentSessionId) {
            currentSessionId = `sanep_${userName.toLowerCase()}_${Date.now()}`;
        }
        formData.append('sessionId', currentSessionId);
        
        // Jika ada gambar, tambahkan ke formData
        if (imageData) {
            const blob = await fetch(imageData).then(r => r.blob());
            formData.append('image', blob, 'uploaded_image.jpg');
        }
        
        const response = await fetch(API_URL, {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('GPT-4o Response:', data);
        
        // Simpan sessionId dari response
        if (data.sessionId) {
            currentSessionId = data.sessionId;
            
            // Simpan ke session history
            if (!sessionHistory[currentChatId]) {
                sessionHistory[currentChatId] = [];
            }
            sessionHistory[currentChatId].push({
                sessionId: data.sessionId,
                timestamp: new Date().toISOString(),
                hasImage: data.hasImage || false
            });
            
            // Save session history to localStorage
            saveSessionHistory();
        }
        
        if (data.status && data.data && data.data.result) {
            return data.data.result;
        } else {
            throw new Error('Jawaban kosong atau tidak valid dari API GPT-4o.');
        }
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            throw new Error('Timeout: Respons terlalu lama');
        }
        
        console.error("Error calling GPT-4o API:", error);
        throw error;
    }
}

            let systemInstructions = updateSystemInstructions();
            
            // Load custom prompts from localStorage if they exist
            if (localStorage.getItem('customPrompts')) {
                try {
                    const savedPrompts = JSON.parse(localStorage.getItem('customPrompts'));
                    // Only override modes that have custom prompts
                    Object.keys(savedPrompts).forEach(mode => {
                        if (systemInstructions[mode]) {
                            systemInstructions[mode] = savedPrompts[mode];
                        }
                    });
                } catch (e) {
                    console.error("Failed to load custom prompts:", e);
                }
            }

            // Event Listeners
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            function updateSendButtonState() {
                sendBtn.disabled = chatInput.value.trim() === '' && !chatImage;
            }

            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                updateSendButtonState();
            });
            
            imageUploadBtn.addEventListener('click', () => imageUploadInput.click());
            imageUploadInput.addEventListener('change', handleImageUpload);
            themeToggle.addEventListener('click', toggleTheme);
            newChatBtn.addEventListener('click', startNewChat);
            mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            sidebarClose.addEventListener('click', closeMobileMenu);
            
            // Model selector events
            modelSelectorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                modelList.classList.toggle('is-open');
            });
            
            // Update model selector untuk handle image generation models
modelList.addEventListener('click', (e) => {
    const target = e.target.closest('.model-item');
    if (!target) return;
    
    const selectedModel = target.dataset.model;
    console.log('Selected model:', selectedModel);
    
    if (selectedModel === 'nano-banana') {
        openNanoBanana();
    } else if (selectedModel === 'flux-pro' || selectedModel === 'animagine-xl') {
        console.log('Opening image gen modal for:', selectedModel);
        openImageGenModal(selectedModel);
    } else {
        updateModel(selectedModel);
    }
    
    modelList.classList.remove('is-open');
});
            document.addEventListener('click', (e) => {
                if (!modelSelectorBtn.contains(e.target) && !modelList.contains(e.target)) {
                    modelList.classList.remove('is-open');
                }
            });
            
            // Settings menu events
            settingsMenuButton.addEventListener('click', () => {
                settingsMenuDropdown.classList.toggle('show');
            });

            window.addEventListener('click', (e) => {
                if (!settingsMenuButton.contains(e.target) && !settingsMenuDropdown.contains(e.target)) {
                    settingsMenuDropdown.classList.remove('show');
                }
            });
            
            // Di event listener settings menu
// Di event listener settings menu, tambahkan:
// Di event listener settings menu, tambahkan:
settingsMenuDropdown.addEventListener('click', (e) => {
    const target = e.target.closest('.dropdown-item');
    if (!target) return;
    
    const mode = target.dataset.mode;
    if (mode === 'clear') {
        clearCurrentChat();
    } else if (target.id === 'edit-prompt-btn') {
        openPromptEditor();
    } else if (target.id === 'edit-schedule-btn') {
        openScheduleEditor();
    } else if (target.id === 'notification-settings-btn') { // TAMBAH INI
        openNotificationSettings();
    } else if (target.id === 'test-notification-btn') { // TAMBAH INI
        sendTestNotification();
    } else if (target.id === 'clear-all-history') {
        clearAllHistory();
    } else if (mode) {
        updateMode(mode);
    }
    
    settingsMenuDropdown.classList.remove('show');
});

// Fungsi untuk pengaturan notifikasi
function openNotificationSettings() {
    const settingsHTML = `
        <div id="notification-settings" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--surface-light); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                        <i class="fas fa-bell"></i> Pengaturan Notifikasi
                    </div>
                    <button onclick="closeNotificationSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--primary);">Status Notifikasi</h4>
                    <div style="background: var(--bg-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas ${notificationPermission ? 'fa-check-circle' : 'fa-times-circle'}" 
                               style="color: ${notificationPermission ? 'var(--success)' : 'var(--error)'};"></i>
                            <span>Notifikasi: <strong>${notificationPermission ? 'AKTIF' : 'NONAKTIF'}</strong></span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            ${notificationPermission ? 
                                '🔔 Anda akan mendapat pengingat jadwal setiap hari jam 5 pagi' :
                                '🔕 Aktifkan notifikasi untuk pengingat harian'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--primary);">Jadwal Pengingat</h4>
                    <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-clock"></i>
                            <span>Setiap hari: <strong>05:00 WIB</strong></span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            Mengingatkan jadwal pelajaran hari ini
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    ${!notificationPermission ? 
                        `<button onclick="requestNotificationPermission()" style="background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                            <i class="fas fa-bell"></i> Aktifkan Notifikasi
                        </button>` : 
                        `<button onclick="sendScheduleNotificationNow()" style="background: var(--success); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                            <i class="fas fa-paper-plane"></i> Kirim Sekarang
                        </button>`
                    }
                    <button onclick="sendTestNotification()" style="background: var(--warning); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                        <i class="fas fa-vial"></i> Test Notifikasi
                    </button>
                    <button onclick="closeNotificationSettings()" style="background: var(--error); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing settings if any
    const existing = document.getElementById('notification-settings');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', settingsHTML);
    document.getElementById('notification-settings').classList.remove('hidden');
}

function closeNotificationSettings() {
    const settings = document.getElementById('notification-settings');
    if (settings) settings.remove();
}
            
            // Prompt editor events
            editPromptBtn.addEventListener('click', openPromptEditor);
            promptEditorClose.addEventListener('click', closePromptEditor);
            cancelPromptBtn.addEventListener('click', closePromptEditor);
            savePromptBtn.addEventListener('click', saveCustomPrompt);
            
            // Nano Banana events
            nanoBananaClose.addEventListener('click', closeNanoBanana);
            nanoMethodSelect.addEventListener('change', handleNanoMethodChange);
            nanoImageInput.addEventListener('change', handleNanoImageUpload);
            nanoProcessBtn.addEventListener('click', processNanoBanana);
            nanoClearBtn.addEventListener('click', clearNanoBanana);

            // Initialize
            loadTheme();
            loadChatHistory();
          
initializeChat();
initializeNotifications(); // TAMBAH INI

            // Functions
            function initializeChat() {
                if (!currentChatId) {
                    currentChatId = 'chat_' + Date.now();
                }
                
                // Load current conversation if it exists
                const currentConversation = userProfile.conversations[currentChatId];
                if (currentConversation && currentConversation.messages.length > 0) {
                    welcomeScreen.style.display = 'none';
                    currentConversation.messages.forEach(msg => {
                        addMessageToUI(msg.content, msg.role, msg.image);
                    });
                }
                updateSendButtonState(); // Set initial button state
            }

            function sendMessage() {
    const message = chatInput.value.trim();
    if (message === '' && !chatImage) return;
    
    // Check if user is telling their name
    if (message.toLowerCase().includes('nama saya') || message.toLowerCase().includes('nama ku') || 
        message.toLowerCase().includes('saya bernama') || message.toLowerCase().includes('panggil saya')) {
        extractUserName(message);
    }

    welcomeScreen.style.display = 'none';
    
    // Add user message to chat
    addMessageToUI(message, 'user', chatImage);
    saveMessage(message, 'user', chatImage);
    
    // Clear input immediately
    const originalMessage = chatInput.value;
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    showTypingIndicator();
    clearMediaPreview();
    
    console.log('📤 Sending message to AI...');
    console.log('Original message:', originalMessage);
    console.log('Current model:', currentModel);
    console.log('Has image:', !!chatImage);
    
    // Generate AI response dengan timeout
    const aiTimeout = setTimeout(() => {
        console.log('⏰ AI response timeout - taking too long');
        removeTypingIndicator();
        const timeoutMsg = "Maaf, respons AI terlalu lama. Coba lagi atau gunakan model lain.";
        addMessageToUI(timeoutMsg, 'bot');
        saveMessage(timeoutMsg, 'bot');
        showNotification("AI timeout - coba lagi", "warning");
    }, 30000); // 30 second timeout
    
    generateAIResponse(originalMessage, chatImage)
        .then(response => {
            clearTimeout(aiTimeout);
            removeTypingIndicator();
            addMessageToUI(response, 'bot');
            saveMessage(response, 'bot');
            console.log('✅ AI response received successfully');
        })
        .catch(error => {
            clearTimeout(aiTimeout);
            removeTypingIndicator();
            console.error('❌ AI Error:', error);
            const errorMsg = `Maaf, saya mengalami gangguan teknis: ${error.message}. Silakan coba lagi nanti.`;
            addMessageToUI(errorMsg, 'bot');
            saveMessage(errorMsg, 'bot');
            showNotification("Error: Gagal mendapatkan respons dari AI", "error");
        })
        .finally(() => {
            chatImage = null; // Reset chatImage after sending
        });
}
            
            function extractUserName(message) {
                const namePatterns = [
                    /nama saya adalah? (.+)/i,
                    /nama ku adalah? (.+)/i,
                    /saya bernama (.+)/i,
                    /panggil saya (.+)/i,
                    /namaku (.+)/i,
                    /nama saya (.+)/i
                ];
                
                for (const pattern of namePatterns) {
                    const match = message.match(pattern);
                    if (match && match[1]) {
                        const newName = match[1].trim().split(/[.,!?]/)[0]; // Take only first part before punctuation
                        if (newName.length > 1) { // Ensure it's a valid name
                            updateUserName(newName);
                            return;
                        }
                    }
                }
            }
            
            function updateUserName(newName) {
                userName = newName;
                userProfile.name = newName;
                
                // Update system instructions with new name
                systemInstructions = updateSystemInstructions();
                
                // Save to localStorage
                localStorage.setItem('sanepAI_userProfile', JSON.stringify(userProfile));
                
                // Update UI
                updateUserNameInUI();
                
                showNotification(`Halo ${userName}! Senang berkenalan dengan Anda.`);
            }
            
            function updateUserNameInUI() {
                const userNames = document.querySelectorAll('.user-name');
                userNames.forEach(el => {
                    el.textContent = userName;
                });
            }
            
           
            
            async function sendGeminiMessage(systemPrompt, message, imageData = null) {
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAMES.gemini}:generateContent?key=${API_KEYS.gemini}`;
    
    console.log('🔄 Preparing Gemini request...');
    console.log('Message:', message);
    console.log('Has image:', !!imageData);
    
    try {
        const parts = [];
        
        if (imageData) {
            console.log('📸 Processing image for Gemini...');
            const base64Data = imageData.split(',')[1];
            parts.push({
                inlineData: {
                    mimeType: "image/jpeg",
                    data: base64Data
                }
            });
        }
        
        parts.push({ text: message });

        // Include conversation history for context
        const currentConversation = userProfile.conversations[currentChatId];
        const history = currentConversation ? currentConversation.messages.slice(-6) : [];
        
        const contents = [];
        
        // Add system instruction
        contents.push({
            role: 'user',
            parts: [{ text: systemPrompt }]
        });
        
        // Add conversation history
        history.forEach(msg => {
            if (msg.role === 'user') {
                const userParts = [{ text: msg.content }];
                if (msg.image) {
                    const base64Data = msg.image.split(',')[1];
                    userParts.push({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: base64Data
                        }
                    });
                }
                contents.push({
                    role: 'user',
                    parts: userParts
                });
            } else {
                contents.push({
                    role: 'model',
                    parts: [{ text: msg.content }]
                });
            }
        });
        
        // Add current message
        contents.push({
            role: 'user',
            parts: parts
        });

        console.log('🚀 Sending request to Gemini API...');
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: contents,
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            })
        });

        console.log('📨 Gemini response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Gemini API Error:', errorText);
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('✅ Gemini API Response:', data);
        
        if (data.candidates && data.candidates[0].content.parts[0].text) {
            return data.candidates[0].content.parts[0].text;
        } else {
            throw new Error('Jawaban kosong atau tidak valid dari API Gemini.');
        }
    } catch (error) {
        console.error("❌ Error calling Gemini API:", error);
        throw error;
    }
}
            
            // Update fungsi sendOtherModelMessage
async function sendOtherModelMessage(systemPrompt, userMessageText) {
    // Fallback response hanya untuk model yang belum diimplementasi
    const responses = {
        'blackbox': `Halo ${userName}! Model Blackbox sedang dalam pengembangan. Untuk sekarang, coba pakai Gemini atau GPT-4o ya!`,
        'deepseek': `Hai ${userName}! DeepSeek akan segera hadir. Sementara pakai Gemini atau GPT-4o dulu!`,
        'luminai': `${userName}, Luminai masih dalam tahap penyempurnaan. Model Gemini dan GPT-4o sudah siap membantu!`,
        'llama': `Wah, Llama masih belum ready nih. Aku sarankan pakai Gemini atau GPT-4o dulu!`,
        'mistral': `Mistral sedang tidak tersedia. Tapi Gemini dan GPT-4o siap membantumu!`,
        'qwq': `QWQ model masih dalam development. Coba pakai Gemini atau GPT-4o ya!`,
        'perplexity': `Perplexity belum tersedia. Gemini dan GPT-4o sudah siap kok!`,
        'hutao-cai': `Hu Tao CAI masih dalam pengembangan. Sementara pakai model lain dulu!`,
        'gemini-beta': `Gemini Beta sedang maintenance. Pakai Gemini reguler atau GPT-4o saja!`,
        'gpt3': `GPT-3.5 sedang tidak tersedia. GPT-4o dan Gemini siap membantu!`,
        'gpt4': `GPT-4 sedang upgrade. Coba pakai GPT-4o atau Gemini!`,
        'flux-image': `Flux Image processor akan segera hadir!`,
        'ghibli-image': `Ghibli style transfer sedang disiapkan!`,
        'videogpt-video': `VideoGPT untuk processing video coming soon!`
    };
    
    return responses[currentModel] || `Halo ${userName}! Model ${currentModel} sedang dalam pengembangan. Untuk sekarang, coba pakai Gemini atau GPT-4o ya!`;
}
            
            function addMessageToUI(content, role, imageData = null) {
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${role}-message`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : '<img src="https://files.catbox.moe/70gv96.png" alt="AI" style="width:20px;height:20px;">';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                if (imageData && role === 'user') {
                    messageContent.innerHTML = `
                        <div class="message-text">${content || ''}</div>
                        <img src="${imageData}" class="message-image" alt="Gambar yang diunggah">
                    `;
                } else {
                    messageContent.innerHTML = `<div class="message-text">${formatText(content)}</div>`;
                }
                
                messageContainer.appendChild(avatar);
                messageContainer.appendChild(messageContent);
                chatContainer.appendChild(messageContainer);
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // Optional: Simpan session info di user profile juga
function saveMessage(content, role, imageData = null) {
    if (!userProfile.conversations[currentChatId]) {
        userProfile.conversations[currentChatId] = {
            id: currentChatId,
            title: content.substring(0, 30) + (content.length > 30 ? '...' : ''),
            timestamp: new Date().toISOString(),
            messages: [],
            lastSessionId: currentSessionId // Simpan sessionId terakhir
        };
    }

    // Update lastSessionId
    userProfile.conversations[currentChatId].lastSessionId = currentSessionId;

    // Jangan simpan imageData di localStorage karena terlalu besar
    userProfile.conversations[currentChatId].messages.push({
        role: role,
        content: content,
        image: null,
        timestamp: new Date().toISOString(),
        sessionId: currentSessionId // Simpan sessionId untuk setiap message
    });

    // Save to localStorage
    try {
        localStorage.setItem('sanepAI_userProfile', JSON.stringify(userProfile));
    } catch (error) {
        console.error('LocalStorage error:', error);
        clearOldConversations();
    }

    // Update chat history UI
    loadChatHistory();
}

// Fungsi untuk clear conversation lama
function clearOldConversations() {
    const conversations = Object.values(userProfile.conversations)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(5); // Keep only last 5 conversations
    
    userProfile.conversations = {};
    conversations.forEach(conv => {
        userProfile.conversations[conv.id] = conv;
    });
    
    try {
        localStorage.setItem('sanepAI_userProfile', JSON.stringify(userProfile));
        showNotification('Beberapa percakapan lama dihapus untuk menghemat ruang', 'info');
    } catch (error) {
        // Jika masih error, clear semua
        localStorage.removeItem('sanepAI_userProfile');
        userProfile.conversations = {};
        showNotification('LocalStorage penuh, semua history direset', 'warning');
    }
}
            
            function formatText(text) {
    // First, handle code blocks
    text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        return formatCodeBlock(code.trim(), lang);
    });
    
    // Then handle inline code
    text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
    
    // Then handle other formatting
    text = text.replace(/\n/g, '<br>');
    text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
    text = text.replace(/_(.*?)_/g, '<em>$1</em>');
    
    return text;
}
            
            function showTypingIndicator() {
                const typingContainer = document.createElement('div');
                typingContainer.className = 'message-container bot-message';
                typingContainer.id = 'typing-indicator';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = '<img src="https://files.catbox.moe/70gv96.png" alt="AI" style="width:20px;height:20px;">';
                
                const typingContent = document.createElement('div');
                typingContent.className = 'typing-indicator';
                typingContent.innerHTML = `
                   <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                `;
                
                typingContainer.appendChild(avatar);
                typingContainer.appendChild(typingContent);
                chatContainer.appendChild(typingContainer);
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.match('image.*')) {
        showNotification('Hanya file gambar yang didukung!', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Ukuran gambar maksimal 5MB!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (event) => {
        chatImage = event.target.result;
        showMediaPreview(chatImage, file.name);
        updateSendButtonState(); // Update button state after adding image
    };
    reader.onerror = (error) => {
        console.error('Error reading file:', error);
        showNotification('Gagal membaca file gambar', 'error');
    };
    reader.readAsDataURL(file);
}
            
            function showMediaPreview(imageData, fileName) {
                mediaPreview.innerHTML = `
                    <div class="media-preview">
                        <img src="${imageData}" alt="Preview">
                        <div class="media-preview-info">
                            <div>${fileName}</div>
                            <div class="media-preview-actions">
                                <button class="media-preview-btn" onclick="clearMediaPreview()">
                                    <i class="fas fa-times"></i> Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                mediaPreview.classList.remove('hidden');
            }
            
            function clearMediaPreview() {
    mediaPreview.innerHTML = '';
    mediaPreview.classList.add('hidden');
    imageUploadInput.value = '';
    chatImage = null; // Reset the image data
    updateSendButtonState(); // Update button state after removing image
}
            
            function toggleTheme() {
                const currentTheme = document.body.getAttribute('data-theme');
                let newTheme;
                
                // Cycle through themes: light -> dark -> purple -> light
                if (currentTheme === 'light') {
                    newTheme = 'dark';
                } else if (currentTheme === 'dark') {
                    newTheme = 'purple';
                } else {
                    newTheme = 'light';
                }
                
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('sanepAI_theme', newTheme);
                updateThemeIcon(newTheme);
                
                const themeNames = {
                    'light': 'Terang',
                    'dark': 'Gelap', 
                    'purple': 'Ungu'
                };
                
                showNotification(`Tema diubah ke: ${themeNames[newTheme]}`, "info");
            }
            
            function updateThemeIcon(theme) {
                const icon = themeToggle.querySelector('i');
                if (theme === 'light') {
                    icon.className = 'fas fa-sun';
                } else if (theme === 'dark') {
                    icon.className = 'fas fa-moon';
                } else {
                    icon.className = 'fas fa-palette';
                }
            }
            
            function loadTheme() {
                const savedTheme = localStorage.getItem('sanepAI_theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : 
                                      savedTheme === 'purple' ? '<i class="fas fa-palette"></i>' : 
                                      '<i class="fas fa-moon"></i>';
            }
            
            function startNewChat() {
                // Clear current chat UI
                const messages = document.querySelectorAll('.message-container');
                messages.forEach(msg => msg.remove());
                
                // Show welcome screen
                welcomeScreen.style.display = 'flex';
                
                // Create new chat ID
                currentChatId = 'chat_' + Date.now();
                
                // Close mobile sidebar
                closeMobileMenu();
                
                showNotification('Percakapan baru dimulai');
            }
            
            function toggleMobileMenu() {
                sidebar.classList.add('open');
            }
            
            function closeMobileMenu() {
                sidebar.classList.remove('open');
            }
            
            // ==================== NOTIFICATION TOAST FUNCTION ====================
function showNotification(message, type = 'info') {
console.log(`🔔 ${type.toUpperCase()}: ${message}`);

// Create notification element if not exists
let notification = document.getElementById('custom-notification');
if (!notification) {
notification = document.createElement('div');
notification.id = 'custom-notification';
notification.style.cssText = `
position: fixed;
top: 20px;
right: 20px;
padding: 16px 20px;
border-radius: 8px;
background: #333;
color: white;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 10000;
max-width: 400px;
transform: translateX(400px);
transition: transform 0.3s ease;
font-family: system-ui, -apple-system, sans-serif;
`;
document.body.appendChild(notification);
}

// Set style based on type
const colors = {
success: '#4CAF50',
error: '#f44336',
warning: '#ff9800',
info: '#2196F3'
};

notification.style.background = colors[type] || colors.info;
notification.textContent = message;

// Show notification
notification.style.transform = 'translateX(0)';

// Auto hide after 4 seconds
setTimeout(() => {
if (notification.parentElement) {
notification.style.transform = 'translateX(400px)';
setTimeout(() => {
if (notification.parentElement) {
notification.remove();
}
}, 300);
}
}, 4000);
}

// Fallback untuk existing notification system
if (typeof window.showNotification === 'undefined') {
window.showNotification = showNotification;
}
            
            function loadChatHistory() {
                chatHistory.innerHTML = '';

                const conversations = Object.values(userProfile.conversations)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 10); // Show only last 10 conversations

                conversations.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.innerHTML = `
                        <i class="fas fa-comment"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${chat.title}</div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                ${new Date(chat.timestamp).toLocaleDateString('id-ID')}
                            </div>
                        </div>
                    `;

                    chatItem.addEventListener('click', () => {
                        loadChat(chat.id);
                    });

                    chatHistory.appendChild(chatItem);
                });
            }

            function loadChat(chatId) {
                const conversation = userProfile.conversations[chatId];
                if (!conversation) return;

                // Clear current chat
                const messages = document.querySelectorAll('.message-container');
                messages.forEach(msg => msg.remove());

                // Hide welcome screen
                welcomeScreen.style.display = 'none';
                
                // Set current chat ID
                currentChatId = chatId;

                // Load messages
                conversation.messages.forEach(msg => {
                    addMessageToUI(msg.content, msg.role, msg.image);
                });

                // Close mobile menu
                closeMobileMenu();

                showNotification('Percakapan dimuat');
            }
            
            function clearCurrentChat() {
                if (userProfile.conversations[currentChatId]) {
                    delete userProfile.conversations[currentChatId];
                    localStorage.setItem('sanepAI_userProfile', JSON.stringify(userProfile));
                }
                
                startNewChat();
                showNotification('Percakapan telah dibersihkan');
            }
            
            function updateMode(newMode) {
                currentMode = newMode;
                const allItems = document.querySelectorAll('.dropdown-item[data-mode]');
                
                allItems.forEach(item => {
                    if (item.dataset.mode === newMode) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                showNotification(`Mode diubah menjadi: ${newMode.replace('-', ' ')}`);
            }
            
            function updateModel(newModel) {
                currentModel = newModel;
                const allItems = document.querySelectorAll('.model-item');
                
                allItems.forEach(item => {
                    if (item.dataset.model === newModel) {
                        item.classList.add('active');
                        currentModelName.textContent = item.textContent;
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                showNotification(`Model diubah menjadi: ${newModel}`);
            }
            
            function openPromptEditor() {
                customPromptTextarea.value = systemInstructions[currentMode] || '';
                promptEditor.classList.remove('hidden');
                customPromptTextarea.focus();
            }

            function closePromptEditor() {
                promptEditor.classList.add('hidden');
            }

            function saveCustomPrompt() {
                const customPrompt = customPromptTextarea.value.trim();
                if (customPrompt) {
                    systemInstructions[currentMode] = customPrompt;
                    
                    localStorage.setItem('customPrompts', JSON.stringify({
                        [currentMode]: customPrompt
                    }));
                    
                    showNotification('Custom prompt berhasil disimpan!');
                    closePromptEditor();
                }
            }
            
            // Nano Banana Functions
            function openNanoBanana() {
                nanoBananaModal.classList.add('show');
            }
            
            function closeNanoBanana() {
                nanoBananaModal.classList.remove('show');
            }
            
            function handleNanoMethodChange() {
                const method = nanoMethodSelect.value;
                
                if (method === 'post') {
                    document.getElementById('post-method').style.display = 'block';
                    document.getElementById('get-method').style.display = 'none';
                    nanoUrlInput.value = '';
                } else {
                    document.getElementById('post-method').style.display = 'none';
                    document.getElementById('get-method').style.display = 'block';
                    nanoImageInput.value = '';
                    nanoSelectedFile = null;
                    nanoFileUploadLabel.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Klik untuk memilih gambar atau tarik file ke sini';
                    nanoFileUploadLabel.classList.remove('has-file');
                    nanoBackupOption.checked = false;
                }
                updateNanoPreview();
            }
            
            function handleNanoImageUpload(e) {
                if (this.files && this.files[0]) {
                    nanoSelectedFile = this.files[0];
                    nanoFileUploadLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${nanoSelectedFile.name} (${(nanoSelectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                    nanoFileUploadLabel.classList.add('has-file');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        updateNanoPreview(e.target.result);
                    };
                    reader.readAsDataURL(nanoSelectedFile);
                }
            }
            
            function updateNanoPreview(originalImageUrl = null) {
                if (!originalImageUrl) {
                    nanoBananaComparison.innerHTML = `
                        <div class="comparison-item">
                            <h3>Gambar Asli</h3>
                            <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #5f6368;">
                                <i class="fas fa-image" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                        <div class="comparison-item">
                            <h3>Hasil AI</h3>
                            <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #5f6368;">
                                <i class="fas fa-hourglass-half" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    `;
                    return;
                }

                nanoBananaComparison.innerHTML = `
                    <div class="comparison-item">
                        <h3>Gambar Asli</h3>
                        <img src="${originalImageUrl}" class="comparison-image" alt="Original Image">
                        ${nanoSelectedFile ? `<p>Ukuran: ${(nanoSelectedFile.size / 1024).toFixed(2)} KB</p>` : ''}
                    </div>
                    <div class="comparison-item">
                        <h3>Hasil AI</h3>
                        <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #5f6368;">
                            <i class="fas fa-hourglass-half" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                `;
            }
            
            async function uploadToCDN(imageFile) {
                console.log('Mengupload gambar ke CDN...');
                
                const formData = new FormData();
                formData.append('file', imageFile);
                
                const response = await fetch('https://swagger-nextjs-one.vercel.app/api/cdn', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`CDN upload failed! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('CDN Response:', data);
                
                if (data.status && data.data && data.data.url) {
                    return data.data.url;
                } else {
                    throw new Error('CDN upload gagal: ' + (data.message || 'Unknown error'));
                }
            }
            
            async function processWithPost(imageFile, prompt, useBackup = false) {
                let imageUrl;
                
                if (useBackup) {
                    console.log('Menggunakan backup mode: Upload ke CDN dulu...');
                    imageUrl = await uploadToCDN(imageFile);
                    console.log('Gambar berhasil diupload ke CDN:', imageUrl);
                    
                    // Sekarang proses dengan GET method menggunakan URL dari CDN
                    return await processWithGet(imageUrl, prompt);
                } else {
                    console.log('Menggunakan metode POST langsung...');
                    const formData = new FormData();
                    formData.append('prompt', prompt);
                    formData.append('image', imageFile);
                    
                    const response = await fetch('https://swagger-nextjs-one.vercel.app/api/ai/nano-banana', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    return data;
                }
            }
            
            async function processWithGet(imageUrl, prompt) {
                const encodedUrl = encodeURIComponent(imageUrl);
                const encodedPrompt = encodeURIComponent(prompt);
                
                console.log('Menggunakan metode GET...');
                
                const apiUrl = `https://swagger-nextjs-one.vercel.app/api/ai/nano-banana?prompt=${encodedPrompt}&imageUrl=${encodedUrl}`;
                console.log('GET URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                return data;
            }
            
            function downloadNanoResult() {
                if (!nanoResultUrl) {
                    showNotification('Tidak ada hasil untuk didownload', 'error');
                    return;
                }
                
                try {
                    const a = document.createElement('a');
                    a.href = nanoResultUrl;
                    a.download = `nano_banana_${Date.now()}.jpg`;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showNotification('✅ Gambar berhasil didownload ke galeri!', 'success');
                } catch (error) {
                    showNotification('❌ Gagal download gambar', 'error');
                }
            }
            
            async function processNanoBanana() {
                const method = nanoMethodSelect.value;
                const prompt = nanoPromptInput.value.trim();
                const useBackup = nanoBackupOption.checked && method === 'post';
                
                // Validasi input
                if (!prompt) {
                    showNotification('Silakan masukkan prompt AI', 'warning');
                    nanoPromptInput.focus();
                    return;
                }
                
                if (method === 'post' && !nanoSelectedFile) {
                    showNotification('Silakan pilih gambar terlebih dahulu', 'warning');
                    return;
                }
                
                if (method === 'get' && !nanoUrlInput.value.trim()) {
                    showNotification('Silakan masukkan URL gambar', 'warning');
                    nanoUrlInput.focus();
                    return;
                }
                
                // Validasi file size untuk POST
                if (method === 'post' && nanoSelectedFile.size > 10 * 1024 * 1024) {
                    showNotification('Ukuran file terlalu besar. Maksimal 10MB', 'error');
                    return;
                }
                
                // Show loading dengan status backup
                nanoBananaLoading.style.display = 'flex';
                nanoProcessBtn.disabled = true;
                
                if (useBackup) {
                    nanoProcessBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upload ke CDN...';
                    document.querySelector('.loading-text').textContent = 'Mengupload gambar ke CDN...';
                } else {
                    nanoProcessBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                    document.querySelector('.loading-text').textContent = 'Memproses gambar dengan AI...';
                }
                
                try {
                    let result;
                    let originalImageUrl;
                    
                    if (method === 'post') {
                        console.log(useBackup ? 'Processing dengan backup mode...' : 'Processing dengan POST langsung...');
                        result = await processWithPost(nanoSelectedFile, prompt, useBackup);
                        originalImageUrl = URL.createObjectURL(nanoSelectedFile);
                        
                        // Update loading text untuk proses AI
                        document.querySelector('.loading-text').textContent = 'Memproses gambar dengan AI...';
                    } else {
                        console.log('Processing dengan GET method...');
                        result = await processWithGet(nanoUrlInput.value.trim(), prompt);
                        originalImageUrl = nanoUrlInput.value.trim();
                    }
                    
                    if (result.status && result.result) {
                        nanoResultUrl = result.result;
                        
                        // Tampilkan hasil dengan info backup
                        nanoBananaComparison.innerHTML = `
                            <div class="comparison-item">
                                <h3>Gambar Asli</h3>
                                <img src="${originalImageUrl}" class="comparison-image" alt="Original Image">
                                ${method === 'post' ? `<p>Ukuran: ${(nanoSelectedFile.size / 1024).toFixed(2)} KB</p>` : ''}
                            </div>
                            <div class="comparison-item">
                                <h3>Hasil Nano Banana AI</h3>
                                <img src="${nanoResultUrl}" class="comparison-image" alt="AI Processed Image">
                                <p>Prompt: "${prompt}"</p>
                                ${useBackup ? '<p style="color: var(--primary); font-size: 0.9rem;"><i class="fas fa-shield-alt"></i> Diproses menggunakan Backup Mode</p>' : ''}
                                <div class="download-btn-container">
                                    <button class="nano-btn primary" onclick="downloadNanoResult()">
                                        <i class="fas fa-download"></i> Download ke Galeri
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        showNotification('Berhasil memproses gambar dengan AI!' + (useBackup ? ' (Backup Mode)' : ''), 'success');
                        
                    } else {
                        throw new Error(result.message || 'Gagal memproses gambar');
                    }
                    
                } catch (error) {
                    console.error('Nano Banana Error:', error);
                    
                    // Jika error dan belum pakai backup, sarankan backup
                    if (method === 'post' && !nanoBackupOption.checked) {
                        showNotification('Error: ' + error.message + '. Coba aktifkan Backup Mode', 'error');
                    } else {
                        showNotification('Error: ' + error.message, 'error');
                    }
                } finally {
                    nanoBananaLoading.style.display = 'none';
                    nanoProcessBtn.disabled = false;
                    nanoProcessBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Proses dengan AI';
                    document.querySelector('.loading-text').textContent = 'Memproses gambar dengan AI...';
                }
            }
            
            function clearNanoBanana() {
                nanoImageInput.value = '';
                nanoUrlInput.value = '';
                nanoPromptInput.value = '';
                nanoSelectedFile = null;
                nanoResultUrl = null;
                nanoBackupOption.checked = false;
                nanoFileUploadLabel.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Klik untuk memilih gambar atau tarik file ke sini';
                nanoFileUploadLabel.classList.remove('has-file');
                nanoBananaComparison.innerHTML = '';
                showNotification('Hasil Nano Banana telah dihapus', 'info');
            }
            
            // Make functions available globally
            window.clearMediaPreview = clearMediaPreview;
            window.downloadNanoResult = downloadNanoResult;

            // Initialize mobile menu button
            if (window.innerWidth <= 768) {
                mobileMenuBtn.style.display = 'flex';
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    sidebar.classList.contains('open') &&
                    !sidebar.contains(e.target) &&
                    !mobileMenuBtn.contains(e.target)) {
                    closeMobileMenu();
                }
            });
            
            // Close Nano Banana when clicking outside
            document.addEventListener('click', (e) => {
                if (nanoBananaModal.classList.contains('show') && 
                    e.target === nanoBananaModal) {
                    closeNanoBanana();
                }
            });
// Function to add copy button to message (Updated)
function addCopyButton(messageContent, textToCopy) {
    const copyBtnContainer = document.createElement('div');
    copyBtnContainer.className = 'copy-btn-container';
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Salin';
    copyBtn.title = 'Salin pesan';
    
    copyBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        await copyToClipboard(textToCopy, copyBtn);
    });
    
    copyBtnContainer.appendChild(copyBtn);
    messageContent.appendChild(copyBtnContainer);
}

// Function to copy text to clipboard (Updated)
async function copyToClipboard(text, button) {
    try {
        await navigator.clipboard.writeText(text);
        
        // Visual feedback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
        button.classList.add('copied');
        
        showNotification('Pesan berhasil disalin!', 'success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('copied');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy: ', err);
        
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Visual feedback for fallback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
        button.classList.add('copied');
        
        showNotification('Pesan berhasil disalin!', 'success');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('copied');
        }, 2000);
    }
}

// Function to add message with copy functionality (Updated)
function addMessageToUI(content, role, imageData = null) {
    const messageContainer = document.createElement('div');
    messageContainer.className = `message-container ${role}-message`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : '<img src="https://files.catbox.moe/70gv96.png" alt="AI" style="width:20px;height:20px;">';
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    if (imageData && role === 'user') {
        messageContent.innerHTML = `
            <div class="message-text">${content || ''}</div>
            <img src="${imageData}" class="message-image" alt="Gambar yang diunggah">
        `;
    } else {
        // Parse response untuk auto-detect code
        const parsedContent = role === 'bot' ? parseAIResponse(content) : content;
        messageContent.innerHTML = `<div class="message-text">${formatText(parsedContent)}</div>`;
    }
    
    // Add copy button for bot messages
    if (role === 'bot') {
        addCopyButton(messageContent, content);
    }
    
    messageContainer.appendChild(avatar);
    messageContainer.appendChild(messageContent);
    chatContainer.appendChild(messageContainer);
    
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Fungsi untuk clear semua history
function clearAllHistory() {
    if (confirm('Apakah Anda yakin ingin menghapus semua riwayat percakapan?')) {
        localStorage.removeItem('sanepAI_userProfile');
        userProfile.conversations = {};
        loadChatHistory();
        showNotification('Semua riwayat percakapan telah dihapus', 'success');
    }
}

// Function to detect programming language
function detectProgrammingLanguage(code) {
    // Simple and safe detection
    if (code.includes('function') || code.includes('const ') || code.includes('let ') || code.includes('var ')) return 'javascript';
    if (code.includes('def ') || code.includes('print(')) return 'python';
    if (code.includes('public class') || code.includes('System.out')) return 'java';
    if (code.includes('<?php')) return 'php';
    if (code.includes('#include')) return 'c++';
    if (code.includes('using System')) return 'c#';
    if (code.includes('SELECT') || code.includes('INSERT')) return 'sql';
    if (code.includes('<html') || code.includes('<!DOCTYPE')) return 'html';
    if (code.includes('{') && code.includes('}') && code.includes(':')) return 'css';
    if (code.includes('fn ') || code.includes('println!')) return 'rust';
    if (code.includes('package main')) return 'go';
    
    return 'text';
}

// Function to format code block with syntax highlighting
function formatCodeBlock(code, language = 'text') {
    const lang = language === 'text' ? detectProgrammingLanguage(code) : language;
    
    // Escape HTML entities
    const escapedCode = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');

    return `
        <div class="code-block-container">
            <div class="code-header">
                <span class="code-language">${lang.toUpperCase()}</span>
                <button class="copy-code-btn" onclick="copyCodeToClipboard(this)">
                    <i class="fas fa-copy"></i> Salin
                </button>
            </div>
            <pre class="code-block" data-language="${lang}"><code>${escapedCode}</code></pre>
        </div>
    `;
}
// Function to copy code to clipboard
async function copyCodeToClipboard(button) {
    const codeBlock = button.closest('.code-block-container').querySelector('.code-block');
    const code = codeBlock.textContent;
    
    try {
        await navigator.clipboard.writeText(code);
        
        // Visual feedback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
        button.classList.add('copied');
        
        showNotification('Kode berhasil disalin!', 'success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('copied');
        }, 2000);
        
    } catch (err) {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
        button.classList.add('copied');
        
        showNotification('Kode berhasil disalin!', 'success');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('copied');
        }, 2000);
    }
}
// Enhanced function to parse AI response and auto-detect code
function parseAIResponse(response) {
    // Jika response mengandung code blocks yang jelas, gunakan itu
    if (response.includes('```')) {
        return response;
    }
    
    // Auto-detect jika response terlihat seperti code
    const lines = response.split('\n');
    let codeLines = [];
    let inCodeBlock = false;
    
    for (const line of lines) {
        const trimmedLine = line.trim();
        
        // Deteksi awal code block
        if (!inCodeBlock && (
            trimmedLine.startsWith('function ') ||
            trimmedLine.startsWith('class ') ||
            trimmedLine.startsWith('def ') ||
            trimmedLine.startsWith('import ') ||
            trimmedLine.startsWith('package ') ||
            trimmedLine.match(/^[a-zA-Z_$][a-zA-Z0-9_$]*\s*\(/) ||
            trimmedLine.match(/^[a-zA-Z_$][a-zA-Z0-9_$]*\s*=/) ||
            trimmedLine.includes('{') && trimmedLine.includes('}')
        )) {
            inCodeBlock = true;
            codeLines.push('```' + detectProgrammingLanguage(response));
        }
        
        if (inCodeBlock) {
            codeLines.push(line);
        } else {
            codeLines.push(line);
        }
    }
    
    if (inCodeBlock) {
        codeLines.push('```');
    }
    
    return codeLines.join('\n');
}

// Auto-save draft functionality
function initializeAutoSave() {
    const chatInput = document.getElementById('chatInput');
    let saveTimeout;
    
    // Load draft when page loads
    loadDraft();
    
    chatInput.addEventListener('input', function() {
        // Clear previous timeout
        clearTimeout(saveTimeout);
        
        // Set new timeout to save after 1 second of inactivity
        saveTimeout = setTimeout(() => {
            saveDraft(this.value);
        }, 1000);
    });
    
    // Save draft when leaving page
    window.addEventListener('beforeunload', function() {
        saveDraft(chatInput.value);
    });
    
    // Clear draft when message is sent
    const originalSendMessage = sendMessage;
    window.sendMessage = function() {
        clearDraft();
        originalSendMessage();
    };
}

function saveDraft(text) {
    if (!text.trim()) {
        clearDraft();
        return;
    }
    
    const draft = {
        text: text,
        timestamp: new Date().toISOString(),
        chatId: currentChatId
    };
    
    try {
        localStorage.setItem('sanepAI_draft', JSON.stringify(draft));
        showDraftIndicator();
    } catch (error) {
        console.error('Gagal menyimpan draft:', error);
    }
}

function loadDraft() {
    try {
        const draftData = localStorage.getItem('sanepAI_draft');
        if (draftData) {
            const draft = JSON.parse(draftData);
            const chatInput = document.getElementById('chatInput');
            
            // Only load if it's for the current chat or no specific chat
            if (!draft.chatId || draft.chatId === currentChatId) {
                chatInput.value = draft.text;
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight) + 'px';
                showDraftIndicator(true);
            }
        }
    } catch (error) {
        console.error('Gagal memuat draft:', error);
    }
}

function clearDraft() {
    try {
        localStorage.removeItem('sanepAI_draft');
        hideDraftIndicator();
    } catch (error) {
        console.error('Gagal menghapus draft:', error);
    }
}

function showDraftIndicator(loaded = false) {
    let indicator = document.getElementById('draft-indicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'draft-indicator';
        indicator.className = 'draft-indicator';
        indicator.innerHTML = `
            <span class="draft-text">Draft tersimpan</span>
            <button class="draft-clear" id="draft-clear-btn">
                <i class="fas fa-times"></i>
            </button>
        `;
        document.querySelector('.input-container').appendChild(indicator);
        
        // Add clear button event
        document.getElementById('draft-clear-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            clearDraft();
            document.getElementById('chatInput').value = '';
        });
    }
    
    if (loaded) {
        indicator.querySelector('.draft-text').textContent = 'Draft dimuat';
        indicator.classList.add('loaded');
    }
    
    indicator.classList.add('show');
    
    // Auto hide after 3 seconds
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 3000);
}

function hideDraftIndicator() {
    const indicator = document.getElementById('draft-indicator');
    if (indicator) {
        indicator.classList.remove('show');
    }
}

// Fungsi untuk manage session history
function saveSessionHistory() {
    try {
        localStorage.setItem('sanepAI_sessionHistory', JSON.stringify(sessionHistory));
    } catch (error) {
        console.error('Gagal menyimpan session history:', error);
    }
}

function loadSessionHistory() {
    try {
        const saved = localStorage.getItem('sanepAI_sessionHistory');
        if (saved) {
            sessionHistory = JSON.parse(saved);
        }
    } catch (error) {
        console.error('Gagal memuat session history:', error);
    }
}

// Fungsi untuk get current session info
function getCurrentSessionInfo() {
    return {
        sessionId: currentSessionId,
        chatId: currentChatId,
        timestamp: new Date().toISOString()
    };
}

// Fungsi untuk get session history for current chat
function getSessionHistoryForChat(chatId = null) {
    const targetChatId = chatId || currentChatId;
    return sessionHistory[targetChatId] || [];
}
// Fungsi untuk menampilkan session info (bisa untuk debug)
function showSessionInfo() {
    const sessionInfo = getCurrentSessionInfo();
    const sessionHistoryForChat = getSessionHistoryForChat();
    
    const info = `
Session Info:
- Current Session ID: ${sessionInfo.sessionId || 'Tidak ada'}
- Current Chat ID: ${sessionInfo.chatId}
- Session History: ${sessionHistoryForChat.length} sessions

Session History:
${sessionHistoryForChat.map((session, index) => 
    `${index + 1}. ${session.sessionId} (${new Date(session.timestamp).toLocaleString()})`
).join('\n')}
    `;
    
    console.log('Session Information:', info);
    
    // Bisa juga tampilkan di UI kalau mau
    addMessageToUI(`Session Info:\n${info}`, 'bot');
}

// Update fungsi untuk handle session ketika ganti chat
function loadChat(chatId) {
    const conversation = userProfile.conversations[chatId];
    if (!conversation) return;
    
    // Clear current chat UI
    const messages = document.querySelectorAll('.message-container');
    messages.forEach(msg => msg.remove());
    
    // Hide welcome screen
    welcomeScreen.style.display = 'none';
    
    // Set current chat ID
    currentChatId = chatId;
    
    // Reset sessionId untuk chat baru atau gunakan yang tersimpan
    currentSessionId = null;
    
    // Load session history untuk chat ini jika ada
    const chatSessions = getSessionHistoryForChat(chatId);
    if (chatSessions.length > 0) {
        // Gunakan session terakhir untuk chat ini
        currentSessionId = chatSessions[chatSessions.length - 1].sessionId;
    }
    
    // Load messages
    conversation.messages.forEach(msg => {
        addMessageToUI(msg.content, msg.role, msg.image);
    });
    
    showNotification('Percakapan dimuat');
}

function startNewChat() {
    // Clear current chat UI
    const messages = document.querySelectorAll('.message-container');
    messages.forEach(msg => msg.remove());
    
    // Show welcome screen
    welcomeScreen.style.display = 'flex';
    
    // Create new chat ID
    currentChatId = 'chat_' + Date.now();
    
    // Reset sessionId untuk chat baru
    currentSessionId = `sanep_${userName.toLowerCase()}_${Date.now()}`;
    
    // Close mobile sidebar
    closeMobileMenu();
    
    showNotification('Percakapan baru dimulai');
}
// Contoh cara akses sessionId di console browser
// Ketik di console:
// currentSessionId
// getCurrentSessionInfo()
// getSessionHistoryForChat()

// Atau buat function helper untuk debug
function debugSession() {
    console.log('=== SESSION DEBUG INFO ===');
    console.log('Current Session ID:', currentSessionId);
    console.log('Current Chat ID:', currentChatId);
    console.log('Session History:', sessionHistory);
    console.log('Current Chat Sessions:', getSessionHistoryForChat());
    
    return {
        sessionId: currentSessionId,
        chatId: currentChatId,
        history: getSessionHistoryForChat()
    };
}

// Tambahkan di kode Anda
window.sessionTools = {
    getInfo: function() {
        return {
            sessionId: currentSessionId,
            chatId: currentChatId,
            userName: userName,
            model: currentModel,
            mode: currentMode,
            history: sessionHistory
        };
    },
    
    printInfo: function() {
        const info = this.getInfo();
        console.log('=== SESSION INFO ===');
        console.log('Session ID:', info.sessionId);
        console.log('Chat ID:', info.chatId);
        console.log('User:', info.userName);
        console.log('Model:', info.model);
        console.log('Mode:', info.mode);
        console.log('History:', info.history);
    },
    
    exportAll: function() {
        window.currentSessionId = currentSessionId;
        window.currentChatId = currentChatId;
        window.sessionHistory = sessionHistory;
        window.userName = userName;
        window.currentModel = currentModel;
        window.currentMode = currentMode;
        console.log('✅ All variables exported to global scope');
    }
};

// GANTI bagian fungsi image generation dengan yang ini:

// Image Generation Functions
function openImageGenModal(model) {
    currentImageModel = model;
    
    // Set title based on model
    if (model === 'flux-pro') {
        imageGenTitle.textContent = 'Flux Pro - Image Generation';
    } else if (model === 'animagine-xl') {
        imageGenTitle.textContent = 'Animagine XL 4.0 - Image Generation';
    }
    
    imageGenModal.classList.add('show');
    imagePromptInput.focus();
}

function closeImageGenModal() {
    imageGenModal.classList.remove('show');
    clearImageGen();
}

function clearImageGen() {
    imagePromptInput.value = '';
    imageGenResult.style.display = 'none';
    generatedImageUrl = '';
    generatedImage.src = '';
}

async function generateImage() {
    const prompt = imagePromptInput.value.trim();
    const ratio = imageRatioSelect.value;
    
    if (!prompt) {
        showNotification('Silakan masukkan prompt untuk generate gambar', 'warning');
        imagePromptInput.focus();
        return;
    }
    
    console.log('🎨 Starting image generation...');
    console.log('Model:', currentImageModel);
    console.log('Prompt:', prompt);
    console.log('Ratio:', ratio);
    
    // Show loading
    imageGenLoading.style.display = 'flex';
    imageGenerateBtn.disabled = true;
    imageGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
        // Build API URL langsung - NO PROXY!
        let apiUrl;
        if (currentImageModel === 'flux-pro') {
            apiUrl = `https://api.nekolabs.my.id/ai/flux/pro?prompt=${encodeURIComponent(prompt)}&ratio=${ratio}`;
        } else if (currentImageModel === 'animagine-xl') {
            apiUrl = `https://api.nekolabs.my.id/ai/animagine/xl-4.0?prompt=${encodeURIComponent(prompt)}&ratio=${ratio}`;
        } else {
            throw new Error('Model image tidak dikenali');
        }
        
        console.log('🔗 Calling API directly:', apiUrl);
        
        // Fetch langsung tanpa proxy - gunakan mode 'no-cors' jika perlu
        const response = await fetch(apiUrl, {
            method: 'GET',
            mode: 'cors' // Coba dengan cors dulu
        });
        
        console.log('📨 Response status:', response.status);
        
        if (!response.ok) {
            // Jika CORS error, coba approach berbeda
            if (response.status === 0 || response.type === 'opaque') {
                console.log('CORS issue detected, trying alternative approach...');
                await generateImageAlternative(prompt, ratio);
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('✅ API Response:', data);
        
        if (data.status && data.result) {
            generatedImageUrl = data.result;
            console.log('🖼️ Generated image URL:', generatedImageUrl);
            
            // Tampilkan gambar langsung
            generatedImage.src = generatedImageUrl;
            generatedImage.alt = `Generated: ${prompt}`;
            generatedImage.style.cursor = 'pointer';
            generatedImage.onclick = () => window.open(generatedImageUrl, '_blank');
            
            imageGenResult.style.display = 'grid';
            
            showNotification('🎉 Gambar berhasil digenerate! Klik gambar untuk lihat full size.', 'success');
        } else {
            throw new Error(data.message || 'Respons API tidak valid');
        }
        
    } catch (error) {
        console.error('❌ Image Generation Error:', error);
        
        // Fallback ke metode alternatif
        if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
            console.log('Trying alternative method...');
            await generateImageAlternative(prompt, ratio);
        } else {
            showNotification('❌ Error: ' + error.message, 'error');
        }
    } finally {
        imageGenLoading.style.display = 'none';
        imageGenerateBtn.disabled = false;
        imageGenerateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Image';
    }
}

// Metode alternatif untuk handle CORS
async function generateImageAlternative(prompt, ratio) {
    try {
        showNotification('🔄 Menggunakan metode alternatif...', 'info');
        
        let apiUrl;
        if (currentImageModel === 'flux-pro') {
            apiUrl = `https://api.nekolabs.my.id/ai/flux/pro?prompt=${encodeURIComponent(prompt)}&ratio=${ratio}`;
        } else {
            apiUrl = `https://api.nekolabs.my.id/ai/animagine/xl-4.0?prompt=${encodeURIComponent(prompt)}&ratio=${ratio}`;
        }
        
        // Gunakan fetch dengan no-cors mode
        const response = await fetch(apiUrl, {
            method: 'GET',
            mode: 'no-cors'
        });
        
        // Karena no-cors, kita tidak bisa baca response
        // Tampilkan pesan dan beri instruksi manual
        generatedImageUrl = `https://api.nekolabs.my.id/ai/${currentImageModel === 'flux-pro' ? 'flux/pro' : 'animagine/xl-4.0'}?prompt=${encodeURIComponent(prompt)}&ratio=${ratio}`;
        
        // Buat pesan manual
        imageGenResult.innerHTML = `
            <div class="comparison-item">
                <h3>Generated Image - Manual Access Required</h3>
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
                    <p style="margin-bottom: 15px;">Karena pembatasan browser, gambar tidak bisa langsung ditampilkan.</p>
                    <p style="margin-bottom: 20px;"><strong>Silakan copy URL di bawah dan buka di tab baru:</strong></p>
                    <div style="background: var(--bg-light); padding: 10px; border-radius: 6px; margin-bottom: 15px; word-break: break-all; font-size: 12px;">
                        ${generatedImageUrl}
                    </div>
                    <button class="nano-btn primary" onclick="copyImageUrl()" style="margin-bottom: 10px;">
                        <i class="fas fa-copy"></i> Copy URL
                    </button>
                    <button class="nano-btn secondary" onclick="window.open('${generatedImageUrl}', '_blank')">
                        <i class="fas fa-external-link-alt"></i> Buka di Tab Baru
                    </button>
                </div>
            </div>
        `;
        imageGenResult.style.display = 'grid';
        
        showNotification('⚠️ Gunakan tombol Copy URL atau Buka di Tab Baru', 'warning');
        
    } catch (error) {
        console.error('Alternative method also failed:', error);
        showNotification('❌ Semua metode gagal. Coba lagi nanti.', 'error');
    }
}

// Fungsi untuk copy URL gambar
function copyImageUrl() {
    if (!generatedImageUrl) return;
    
    navigator.clipboard.writeText(generatedImageUrl).then(() => {
        showNotification('✅ URL berhasil disalin!', 'success');
    }).catch(() => {
        // Fallback untuk browser lama
        const textArea = document.createElement('textarea');
        textArea.value = generatedImageUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('✅ URL berhasil disalin!', 'success');
    });
}

function downloadGeneratedImage() {
    if (!generatedImageUrl) {
        showNotification('Tidak ada gambar untuk didownload', 'error');
        return;
    }
    
    console.log('📥 Starting download:', generatedImageUrl);
    
    try {
        // Method 1: Direct download (paling reliable)
        const a = document.createElement('a');
        a.href = generatedImageUrl;
        a.download = `ai_image_${currentImageModel}_${Date.now()}.jpg`;
        a.target = '_blank';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showNotification('✅ Download dimulai! Cek folder downloads.', 'success');
        
    } catch (error) {
        console.error('Download error:', error);
        
        // Method 2: Fallback - buka di tab baru
        showNotification('❌ Gagal download otomatis. Membuka di tab baru...', 'warning');
        setTimeout(() => {
            window.open(generatedImageUrl, '_blank');
        }, 1000);
    }
}

// Jangan lupa tambahkan event listener untuk close modal
document.addEventListener('click', (e) => {
    if (imageGenModal.classList.contains('show') && e.target === imageGenModal) {
        closeImageGenModal();
    }
});

// Update juga fungsi sendOtherModelMessage untuk model image yang baru
async function sendOtherModelMessage(systemPrompt, userMessageText) {
    const responses = {
        'blackbox': `Halo ${userName}! Model Blackbox sedang dalam pengembangan. Untuk sekarang, coba pakai Gemini atau GPT-4o ya!`,
        'deepseek': `Hai ${userName}! DeepSeek akan segera hadir. Sementara pakai Gemini atau GPT-4o dulu!`,
        'luminai': `${userName}, Luminai masih dalam tahap penyempurnaan. Model Gemini dan GPT-4o sudah siap membantu!`,
        'llama': `Wah, Llama masih belum ready nih. Aku sarankan pakai Gemini atau GPT-4o dulu!`,
        'mistral': `Mistral sedang tidak tersedia. Tapi Gemini dan GPT-4o siap membantumu!`,
        'qwq': `QWQ model masih dalam development. Coba pakai Gemini atau GPT-4o ya!`,
        'perplexity': `Perplexity belum tersedia. Gemini dan GPT-4o sudah siap kok!`,
        'hutao-cai': `Hu Tao CAI masih dalam pengembangan. Sementara pakai model lain dulu!`,
        'gemini-beta': `Gemini Beta sedang maintenance. Pakai Gemini reguler atau GPT-4o saja!`,
        'gpt3': `GPT-3.5 sedang tidak tersedia. GPT-4o dan Gemini siap membantu!`,
        'gpt4': `GPT-4 sedang upgrade. Coba pakai GPT-4o atau Gemini!`,
        'flux-pro': `Halo ${userName}! Flux Pro adalah model image generation. Pilih "Flux Pro (Image)" dari dropdown model untuk generate gambar!`,
        'animagine-xl': `Hai ${userName}! Animagine XL 4.0 khusus untuk generate gambar anime. Pilih dari dropdown model untuk mulai!`,
        'flux-image': `Flux Image processor akan segera hadir!`,
        'ghibli-image': `Ghibli style transfer sedang disiapkan!`,
        'videogpt-video': `VideoGPT untuk processing video coming soon!`
    };
    
    return responses[currentModel] || `Halo ${userName}! Model ${currentModel} sedang dalam pengembangan. Untuk sekarang, coba pakai Gemini atau GPT-4o ya!`;
}

// Export fungsi ke global scope untuk akses dari HTML
window.copyImageUrl = copyImageUrl;
window.downloadGeneratedImage = downloadGeneratedImage;    

// Fungsi untuk mendapatkan waktu Indonesia yang akurat - REAL TIME
// ==================== TIME FUNCTIONS ====================

// Fungsi untuk mendapatkan waktu Indonesia yang akurat
function getIndonesianTime() {
    const now = new Date();
    
    // Format waktu untuk Indonesia (WIB, WITA, WIT)
    const timeZones = {
        'WIB': 7, // Jakarta, Java
        'WITA': 8, // Bali, Kalimantan
        'WIT': 9 // Papua, Maluku
    };
    
    // Default ke WIB (kebanyakan user di Java)
    const timezoneOffset = 7;
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const indonesiaTime = new Date(utc + (3600000 * timezoneOffset));
    
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    const dayName = days[indonesiaTime.getDay()];
    const date = indonesiaTime.getDate();
    const month = months[indonesiaTime.getMonth()];
    const year = indonesiaTime.getFullYear();
    const hours = indonesiaTime.getHours().toString().padStart(2, '0');
    const minutes = indonesiaTime.getMinutes().toString().padStart(2, '0');
    const seconds = indonesiaTime.getSeconds().toString().padStart(2, '0');
    
    return {
        dayName,
        date,
        month,
        year,
        hours,
        minutes,
        seconds,
        fullDate: `${dayName}, ${date} ${month} ${year}`,
        fullTime: `${hours}:${minutes}:${seconds}`,
        timeWithZone: `${hours}:${minutes} WIB`,
        timestamp: now.getTime()
    };
}

// Export ke global scope
window.getIndonesianTime = getIndonesianTime;

// Fungsi untuk mendapatkan jadwal hari ini
function getTodaysSchedule() {
    const time = getIndonesianTime();
    const today = time.dayName.toLowerCase();
    
    if (userSchedule[today]) {
        return userSchedule[today];
    }
    return ["Hari ini tidak ada jadwal yang tercatat."];
}

// Fungsi untuk mendapatkan pelajaran selanjutnya
function getNextClass() {
    const time = getIndonesianTime();
    const today = time.dayName.toLowerCase();
    const currentTime = `${time.hours}:${time.minutes}`;
    
    if (!userSchedule[today]) return null;
    
    const schedule = userSchedule[today];
    for (let classTime of schedule) {
        const [timeRange] = classTime.split(' ');
        const [startTime] = timeRange.split('-');
        
        if (startTime > currentTime) {
            return {
                class: classTime,
                timeRemaining: calculateTimeRemaining(currentTime, startTime)
            };
        }
    }
    
    return null;
}

// Fungsi menghitung sisa waktu
function calculateTimeRemaining(currentTime, targetTime) {
    const [currentHours, currentMinutes] = currentTime.split(':').map(Number);
    const [targetHours, targetMinutes] = targetTime.split(':').map(Number);
    
    const currentTotal = currentHours * 60 + currentMinutes;
    const targetTotal = targetHours * 60 + targetMinutes;
    
    if (targetTotal <= currentTotal) return "Sudah dimulai";
    
    const diff = targetTotal - currentTotal;
    const hours = Math.floor(diff / 60);
    const minutes = diff % 60;
    
    if (hours > 0) {
        return `${hours} jam ${minutes} menit lagi`;
    } else {
        return `${minutes} menit lagi`;
    }
}

// Prompt khusus untuk mode Guru
// Prompt khusus untuk mode Guru - DIPERBAIKI
// Prompt khusus untuk mode Guru - VERSI FINAL
function getGuruPrompt() {
    const time = getIndonesianTime();
    const todaySchedule = getTodaysSchedule();
    const nextClass = getNextClass();
    
    let scheduleInfo = `INFORMASI WAKTU REAL-TIME: Hari ini ${time.fullDate}, pukul ${time.timeWithZone}. `;
    scheduleInfo += `Jadwal ${userName} hari ini: ${todaySchedule.join(', ')}. `;
    
    if (nextClass) {
        scheduleInfo += `Pelajaran selanjutnya: ${nextClass.class} (${nextClass.timeRemaining}). `;
    } else {
        scheduleInfo += `Tidak ada pelajaran selanjutnya hari ini. `;
    }
    
    // Tambahkan informasi jadwal lengkap
    scheduleInfo += `\n\nJADWAL LENGKAP ${userName}:\n` +
                   `Senin: ${userSchedule.senin ? userSchedule.senin.join(', ') : 'Tidak ada jadwal'}\n` +
                   `Selasa: ${userSchedule.selasa ? userSchedule.selasa.join(', ') : 'Tidak ada jadwal'}\n` +
                   `Rabu: ${userSchedule.rabu ? userSchedule.rabu.join(', ') : 'Tidak ada jadwal'}\n` +
                   `Kamis: ${userSchedule.kamis ? userSchedule.kamis.join(', ') : 'Tidak ada jadwal'}\n` +
                   `Jumat: ${userSchedule.jumat ? userSchedule.jumat.join(', ') : 'Tidak ada jadwal'}\n` +
                   `Sabtu: ${userSchedule.sabtu ? userSchedule.sabtu.join(', ') : 'Tidak ada jadwal'}\n` +
                   `Minggu: ${userSchedule.minggu ? userSchedule.minggu.join(', ') : 'Tidak ada jadwal'}`;

    return `Kamu adalah SANEP AI, seorang guru yang sabar, bijaksana, dan sangat perhatian terhadap perkembangan ${userName}. 

${scheduleInfo}

PERINTAH PENTING YANG HARUS DIPATUHI:

1. **WAKTU REAL-TIME**: SELALU gunakan waktu saat ini dari fungsi getIndonesianTime(), JANGAN PERNAH gunakan waktu dari pesan user

2. **PERINTAH JADWAL KHUSUS**:
   - Jika user bertanya "sekarang jam berapa?" → berikan waktu real-time saat ini
   - Jika user minta "list jadwal hari [nama hari]" → berikan jadwal lengkap hari tersebut
   - Jika user minta "jadwal hari Senin" → tampilkan jadwal Senin secara detail
   - Jika user bertanya "besok ada pelajaran apa?" → hitung hari besok dan berikan jadwalnya
   - Jika user minta "jadwal lengkap" → tampilkan semua jadwal mingguan

3. **FORMAT RESPONS**:
   - Untuk waktu: "Sekarang hari [hari], [tanggal] [bulan] [tahun] pukul [jam:menit] WIB"
   - Untuk jadwal: gunakan format list dengan nomor dan detail lengkap

4. **CONTOH RESPONS BENAR**:
   "Sekarang hari ${time.dayName}, ${time.date} ${time.month} ${time.year} pukul ${time.timeWithZone}"

   "Ini jadwal hari Senin untukmu:
   1. 07:00-08:30 Matematika
   2. 08:30-10:00 Fisika
   3. 10:30-12:00 Bahasa Indonesia
   4. 13:00-14:30 Kimia
   5. 15:00-16:30 Olahraga"

INGAT: Waktu yang kamu berikan HARUS waktu real-time, bukan waktu dari pesan user!`;
}

// Fungsi untuk buka editor jadwal
function openScheduleEditor() {
    const scheduleEditor = document.getElementById('schedule-editor');
    if (!scheduleEditor) {
        createScheduleEditor();
    }
    document.getElementById('schedule-editor').classList.remove('hidden');
}

// Fungsi untuk buat editor jadwal
function createScheduleEditor() {
    const editorHTML = `
        <div id="schedule-editor" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--surface-light); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">Edit Jadwal Pelajaran</div>
                    <button id="schedule-editor-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                </div>
                <div id="schedule-editor-content">
                    ${generateScheduleEditorHTML()}
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <button id="save-schedule-btn" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Simpan Jadwal</button>
                    <button id="cancel-schedule-btn" style="background: #ccc; color: #333; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Batal</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', editorHTML);
    
    // Event listeners
    document.getElementById('schedule-editor-close').addEventListener('click', closeScheduleEditor);
    document.getElementById('cancel-schedule-btn').addEventListener('click', closeScheduleEditor);
    document.getElementById('save-schedule-btn').addEventListener('click', saveSchedule);
}

function generateScheduleEditorHTML() {
    const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];
    let html = '';
    
    days.forEach(day => {
        const dayName = day.charAt(0).toUpperCase() + day.slice(1);
        html += `
            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-light); border-radius: 8px;">
                <h3 style="margin-bottom: 10px; color: var(--primary);">${dayName}</h3>
                <div id="schedule-${day}" class="schedule-day">
                    ${userSchedule[day] ? userSchedule[day].map((classItem, index) => `
                        <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <input type="text" value="${classItem}" 
                                   style="flex: 1; padding: 8px; border: 1px solid var(--border-light); border-radius: 4px;"
                                   placeholder="Contoh: 07:00-08:30 Matematika">
                            <button type="button" onclick="removeClass('${day}', ${index})" 
                                    style="background: var(--error); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('') : ''}
                </div>
                <button type="button" onclick="addClass('${day}')" 
                        style="background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
                    <i class="fas fa-plus"></i> Tambah Pelajaran
                </button>
            </div>
        `;
    });
    
    return html;
}

// Fungsi bantu untuk editor jadwal
function addClass(day) {
    const container = document.getElementById(`schedule-${day}`);
    const newClass = document.createElement('div');
    newClass.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
    newClass.innerHTML = `
        <input type="text" value="" 
               style="flex: 1; padding: 8px; border: 1px solid var(--border-light); border-radius: 4px;"
               placeholder="Contoh: 07:00-08:30 Matematika">
        <button type="button" onclick="this.parentElement.remove()" 
                style="background: var(--error); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(newClass);
}

function removeClass(day, index) {
    userSchedule[day].splice(index, 1);
    document.getElementById('schedule-editor-content').innerHTML = generateScheduleEditorHTML();
}

function saveSchedule() {
    const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];
    
    days.forEach(day => {
        const container = document.getElementById(`schedule-${day}`);
        const inputs = container.querySelectorAll('input');
        userSchedule[day] = Array.from(inputs).map(input => input.value.trim()).filter(value => value);
    });
    
    // Save to localStorage
    localStorage.setItem('sanepAI_userSchedule', JSON.stringify(userSchedule));
    
    showNotification('✅ Jadwal berhasil disimpan!', 'success');
    closeScheduleEditor();
    
    // Refresh system instructions jika sedang mode guru
    if (currentMode === 'guru') {
        systemInstructions.guru = getGuruPrompt();
    }
}

function closeScheduleEditor() {
    document.getElementById('schedule-editor').classList.add('hidden');
}

// Export fungsi ke global
window.addClass = addClass;
window.removeClass = removeClass;

        // --- Minimal Auth Logic for Admin Button ---
        const ADMIN_UID = "fVdAMsA5s3gA9p0xJ8rY2ZtQW1i1"; // IMPORTANT: Replace with your actual Admin UID
        const editScheduleBtn = document.getElementById('edit-schedule-btn');

        if (typeof firebase !== 'undefined') {
            firebase.auth().onAuthStateChanged(user => {
                if (user && user.uid === ADMIN_UID) {
                    // User is Admin
                    editScheduleBtn.style.display = 'block';
                } else {
                    // User is not Admin or is logged out
                    editScheduleBtn.style.display = 'none';
                }
            });
        } else {
             editScheduleBtn.style.display = 'none';
        }
        });
        
        // Fungsi untuk mendapatkan jadwal hari tertentu
function getScheduleByDay(dayName) {
    const day = dayName.toLowerCase();
    
    if (userSchedule[day]) {
        return userSchedule[day];
    }
    return null;
}

// Fungsi untuk format jadwal menjadi list yang rapi
function formatSchedule(scheduleArray) {
    if (!scheduleArray || scheduleArray.length === 0) {
        return "Tidak ada jadwal untuk hari ini.";
    }
    
    return scheduleArray.map((item, index) => {
        return `${index + 1}. ${item}`;
    }).join('\n');
}

// Fungsi untuk handle permintaan jadwal
function handleScheduleRequest(dayName) {
    const schedule = getScheduleByDay(dayName);
    const time = getIndonesianTime();
    
    if (!schedule) {
        return `Maaf, tidak ada jadwal yang tercatat untuk hari ${dayName}.`;
    }
    
    return `📅 **Jadwal ${userName} hari ${dayName.charAt(0).toUpperCase() + dayName.slice(1)}**\n\n${formatSchedule(schedule)}\n\n*Info: Sekarang ${time.fullDate} pukul ${time.timeWithZone}*`;
}


// ==================== NOTIFICATION SYSTEM ====================

// Initialize notifications// Initialize notifications - VERSI SUPER SAFE
async function initializeNotifications() {
    console.log('🔔 Initializing notification system...');
    
    try {
        // Initialize semua variables
        if (typeof notificationPermission === 'undefined') {
            notificationPermission = false;
        }
        if (typeof notificationTimer === 'undefined') {
            notificationTimer = null;
        }
        if (typeof isNotificationInitialized === 'undefined') {
            isNotificationInitialized = false;
        }
        if (typeof serviceWorkerRegistered === 'undefined') {
            serviceWorkerRegistered = false;
        }
        
        // Check browser support
        if (!('Notification' in window)) {
            console.log('❌ Browser tidak support Notification API');
            return;
        }
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('✅ Service Worker registered');
                serviceWorkerRegistered = true;
            } catch (error) {
                console.log('⚠️ Service Worker registration failed:', error);
                serviceWorkerRegistered = false;
            }
        }
        
        // Check current notification permission
        console.log('🔔 Current notification permission:', Notification.permission);
        
        if (Notification.permission === 'granted') {
            notificationPermission = true;
            console.log('✅ Notification permission already granted');
            safeStartDailyNotifications();
        } else if (Notification.permission === 'default') {
            console.log('🔔 Notification permission not yet requested');
            // Show permission request after a delay
            setTimeout(() => {
                showNotificationPermissionModal();
            }, 3000);
        }
        
        isNotificationInitialized = true;
        console.log('✅ Notification system initialized successfully');
        
    } catch (error) {
        console.error('❌ Error in initializeNotifications:', error);
    }
}

// Show permission request modal
function showNotificationPermission() {
    // Don't show if already decided
    if (Notification.permission !== 'default') return;
    
    const modal = document.getElementById('notification-permission');
    if (modal) {
        modal.style.display = 'flex';
        
        // Clear existing event listeners
        const enableBtn = document.getElementById('enable-notifications');
        const skipBtn = document.getElementById('skip-notifications');
        
        enableBtn.onclick = requestNotificationPermission;
        skipBtn.onclick = () => {
            modal.style.display = 'none';
            console.log('🔕 User skipped notification permission');
        };
    }
}

// Request notification permission
// Request notification permission - VERSI SIMPLIFIED
// Request notification permission - VERSI NO ERROR
async function requestNotificationPermission() {
    console.log('🔔 Requesting notification permission...');
    
    try {
        // Check if Notification API is available
        if (!('Notification' in window)) {
            safeShowNotification('❌ Browser tidak mendukung notifikasi', 'error');
            return;
        }
        
        const permission = await Notification.requestPermission();
        console.log('🔔 Permission result:', permission);
        
        if (permission === 'granted') {
            // Update variables safely
            notificationPermission = true;
            isNotificationInitialized = true;
            
            // Hide permission modal
            try {
                const modal = document.getElementById('notification-permission');
                if (modal) modal.style.display = 'none';
            } catch (e) {
                console.log('⚠️ Error hiding modal:', e);
            }
            
            // Start notifications safely
            safeStartDailyNotifications();
            
            safeShowNotification('🔔 Notifikasi diaktifkan! Pengingat jadwal setiap jam 5 pagi.', 'success');
            console.log('✅ Notification permission granted successfully');
            
        } else {
            notificationPermission = false;
            safeShowNotification('🔕 Notifikasi tidak diizinkan.', 'info');
            console.log('❌ Notification permission denied');
        }
        
    } catch (error) {
        console.error('❌ Error in requestNotificationPermission:', error);
        
        // Show error without using any function that might fail
        const errorMsg = 'Gagal meminta izin notifikasi';
        console.error('❌', errorMsg);
        
        // Use simple alert as last resort
        try {
            safeShowNotification(errorMsg, 'error');
        } catch (e) {
            alert(errorMsg);
        }
    }
}

// Start daily notifications
// Start daily notifications - VERSI SIMPLE
function startDailyNotifications() {
    console.log('📅 Starting daily notifications...');
    
    if (!notificationPermission) {
        console.log('❌ Cannot start notifications - permission not granted');
        return;
    }
    
    // Clear existing timer
    if (notificationTimer) {
        clearTimeout(notificationTimer);
        notificationTimer = null;
    }
    
    // Schedule first notification
    scheduleDailyNotification();
    
    console.log('✅ Daily notifications started');
}

// Schedule daily notification
function scheduleDailyNotification() {
    const now = new Date();
    const targetTime = new Date();
    
    // Set target time to 5:00 AM
    targetTime.setHours(5, 0, 0, 0);
    
    // If it's already past 5:00 AM, schedule for tomorrow
    if (now >= targetTime) {
        targetTime.setDate(targetTime.getDate() + 1);
    }
    
    const timeUntilNotification = targetTime.getTime() - now.getTime();
    
    console.log('⏰ Next notification in:', Math.round(timeUntilNotification / 1000 / 60 / 60), 'hours');
    
    notificationTimer = setTimeout(() => {
        console.log('🔔 Time for daily notification!');
        sendDailyScheduleNotification();
        // Schedule next notification
        scheduleDailyNotification();
    }, timeUntilNotification);
}

// Export ke global scope
window.startDailyNotifications = startDailyNotifications;

// Fallback notification
function sendFallbackNotification(title, body) {
    if (!('Notification' in window)) return;
    
    try {
        new Notification(title, {
            body: body,
            icon: 'https://files.catbox.moe/70gv96.png',
            badge: 'https://files.catbox.moe/70gv96.png'
        });
        console.log('✅ Fallback notification sent');
    } catch (error) {
        console.error('❌ Fallback notification failed:', error);
    }
}

// Test notification
// Test notification - VERSI SAFE
function sendTestNotification() {
    console.log('🧪 Sending test notification...');
    
    try {
        // Check browser support
        if (!('Notification' in window)) {
            const msg = '❌ Browser tidak support notifications';
            console.log(msg);
            safeShowNotification(msg, 'error');
            return;
        }
        
        // Check permission
        if (Notification.permission !== 'granted') {
            const msg = '❌ Silakan aktifkan notifikasi terlebih dahulu';
            console.log(msg);
            safeShowNotification(msg, 'warning');
            return;
        }
        
        // Get current time safely
        let timeInfo = 'Waktu tidak tersedia';
        try {
            if (typeof getIndonesianTime === 'function') {
                const time = getIndonesianTime();
                timeInfo = `${time.dayName} ${time.timeWithZone}`;
            }
        } catch (timeError) {
            console.error('Error getting time:', timeError);
            timeInfo = new Date().toLocaleTimeString('id-ID');
        }
        
        const title = '🔔 Test Notifikasi Sanep AI';
        const body = `Test berhasil! ${timeInfo}`;
        
        safeShowNotification('🔄 Mengirim test notifikasi...', 'info');
        
        // Try Service Worker first, then fallback
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready
                .then(registration => {
                    return registration.showNotification(title, {
                        body: body,
                        icon: 'https://files.catbox.moe/70gv96.png',
                        badge: 'https://files.catbox.moe/70gv96.png',
                        tag: 'test-notification'
                    });
                })
                .then(() => {
                    safeShowNotification('✅ Test notifikasi dikirim!', 'success');
                    console.log('✅ Test notification sent via Service Worker');
                })
                .catch(error => {
                    console.error('❌ Service Worker test failed:', error);
                    sendFallbackTestNotification(title, body);
                });
        } else {
            sendFallbackTestNotification(title, body);
        }
        
    } catch (error) {
        console.error('❌ Error in sendTestNotification:', error);
        safeShowNotification('❌ Gagal mengirim test notifikasi', 'error');
    }
}

// Safe fallback notification function
function sendFallbackTestNotification(title, body) {
    try {
        new Notification(title, {
            body: body,
            icon: 'https://files.catbox.moe/70gv96.png'
        });
        safeShowNotification('✅ Test notifikasi dikirim!', 'success');
        console.log('✅ Fallback test notification sent');
    } catch (error) {
        console.error('❌ Fallback notification failed:', error);
        safeShowNotification('❌ Gagal mengirim test notifikasi', 'error');
    }
}

// Safe notification function that won't crash
function safeShowNotification(message, type = 'info') {
    try {
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            // Fallback to console and alert
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(`${type.toUpperCase()}: ${message}`);
        }
    } catch (error) {
        console.error('Error in safeShowNotification:', error);
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Export ke global scope
window.sendTestNotification = sendTestNotification;
window.safeShowNotification = safeShowNotification;

// Send schedule notification now
function sendScheduleNotificationNow() {
    if (Notification.permission !== 'granted') {
        showNotification('❌ Silakan aktifkan notifikasi terlebih dahulu', 'warning');
        return;
    }
    
    sendDailyScheduleNotification();
    showNotification('✅ Notifikasi jadwal dikirim!', 'success');
}

// Update system instructions with notification info
function getGuruPrompt() {
    const time = getIndonesianTime();
    const todaySchedule = getTodaysSchedule();
    const nextClass = getNextClass();
    
    const notificationInfo = notificationPermission ? 
        '🔔 NOTIFIKASI: AKTIF - Pengingat jadwal dikirim setiap jam 5 pagi' :
        '🔕 NOTIFIKASI: NONAKTIF - Aktifkan di pengaturan untuk pengingat harian';
    
    // ... rest of your existing guru prompt code ...
    // Tambahkan $notificationInfo di system prompt
}
// Close notification settings modal
function closeNotificationSettings() {
    console.log('🔔 Closing notification settings...');
    
    const settingsModal = document.getElementById('notification-settings');
    if (settingsModal) {
        settingsModal.remove();
        console.log('✅ Notification settings closed');
    }
}

// Open notification settings modal
function openNotificationSettings() {
    console.log('🔔 Opening notification settings...');
    
    // Close existing modal first
    closeNotificationSettings();
    
    const settingsHTML = `
        <div id="notification-settings" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--surface-light); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                        <i class="fas fa-bell"></i> Pengaturan Notifikasi
                    </div>
                    <button onclick="closeNotificationSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--primary);">Status Notifikasi</h4>
                    <div style="background: var(--bg-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas ${notificationPermission ? 'fa-check-circle' : 'fa-times-circle'}" 
                               style="color: ${notificationPermission ? 'var(--success)' : 'var(--error)'};"></i>
                            <span>Notifikasi: <strong>${notificationPermission ? 'AKTIF' : 'NONAKTIF'}</strong></span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            ${notificationPermission ? 
                                '🔔 Anda akan mendapat pengingat jadwal setiap hari jam 5 pagi' :
                                '🔕 Aktifkan notifikasi untuk pengingat harian'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--primary);">Jadwal Pengingat</h4>
                    <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-clock"></i>
                            <span>Setiap hari: <strong>05:00 WIB</strong></span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            Mengingatkan jadwal pelajaran hari ini
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    ${!notificationPermission ? 
                        `<button onclick="requestNotificationPermission()" style="background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                            <i class="fas fa-bell"></i> Aktifkan Notifikasi
                        </button>` : 
                        `<button onclick="sendScheduleNotificationNow()" style="background: var(--success); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                            <i class="fas fa-paper-plane"></i> Kirim Sekarang
                        </button>`
                    }
                    <button onclick="sendTestNotification()" style="background: var(--warning); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                        <i class="fas fa-vial"></i> Test Notifikasi
                    </button>
                    <button onclick="closeNotificationSettings()" style="background: var(--error); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; flex: 1;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', settingsHTML);
    console.log('✅ Notification settings opened');
}

// Safe start daily notifications
function safeStartDailyNotifications() {
    console.log('📅 Safe starting daily notifications...');
    
    try {
        if (!notificationPermission) {
            console.log('❌ Cannot start notifications - permission not granted');
            return;
        }
        
        // Clear existing timer safely
        if (notificationTimer !== null && notificationTimer !== undefined) {
            try {
                clearTimeout(notificationTimer);
            } catch (e) {
                console.log('⚠️ Error clearing timer:', e);
            }
            notificationTimer = null;
        }
        
        // Schedule notification
        safeScheduleDailyNotification();
        
        console.log('✅ Daily notifications started safely');
        
    } catch (error) {
        console.error('❌ Error in safeStartDailyNotifications:', error);
    }
}

// Safe schedule daily notification
function safeScheduleDailyNotification() {
    try {
        const now = new Date();
        const targetTime = new Date();
        
        // Set target time to 5:00 AM
        targetTime.setHours(5, 0, 0, 0);
        
        // If it's already past 5:00 AM, schedule for tomorrow
        if (now >= targetTime) {
            targetTime.setDate(targetTime.getDate() + 1);
        }
        
        const timeUntilNotification = targetTime.getTime() - now.getTime();
        
        console.log('⏰ Next notification in:', Math.round(timeUntilNotification / 1000 / 60 / 60), 'hours');
        
        // Set timer safely
        notificationTimer = setTimeout(() => {
            console.log('🔔 Time for daily notification!');
            safeSendDailyScheduleNotification();
            // Schedule next notification
            safeScheduleDailyNotification();
        }, timeUntilNotification);
        
    } catch (error) {
        console.error('❌ Error in safeScheduleDailyNotification:', error);
    }
}

// Safe send daily schedule notification
function safeSendDailyScheduleNotification() {
    console.log('🔔 Safe sending daily schedule notification...');
    
    try {
        if (!notificationPermission) {
            console.log('❌ Cannot send notification - permission not granted');
            return;
        }
        
        // Get schedule info safely
        let scheduleInfo = 'Jadwal hari ini';
        try {
            if (typeof getTodaysSchedule === 'function') {
                const todaySchedule = getTodaysSchedule();
                if (todaySchedule && todaySchedule.length > 0) {
                    scheduleInfo = `Hari ini: ${todaySchedule.length} pelajaran`;
                }
            }
        } catch (e) {
            console.log('⚠️ Error getting schedule:', e);
        }
        
        const title = '📚 Pengingat Jadwal';
        const body = scheduleInfo;
        
        // Send notification safely
        if ('serviceWorker' in navigator && serviceWorkerRegistered) {
            navigator.serviceWorker.ready
                .then(registration => {
                    return registration.showNotification(title, {
                        body: body,
                        icon: 'https://files.catbox.moe/70gv96.png',
                        tag: 'daily-schedule'
                    });
                })
                .then(() => {
                    console.log('✅ Daily notification sent via Service Worker');
                })
                .catch(error => {
                    console.error('❌ Service Worker notification failed:', error);
                    safeSendFallbackNotification(title, body);
                });
        } else {
            safeSendFallbackNotification(title, body);
        }
        
    } catch (error) {
        console.error('❌ Error in safeSendDailyScheduleNotification:', error);
    }
}

// Safe fallback notification
function safeSendFallbackNotification(title, body) {
    try {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: body,
                icon: 'https://files.catbox.moe/70gv96.png'
            });
            console.log('✅ Fallback notification sent');
        }
    } catch (error) {
        console.error('❌ Fallback notification failed:', error);
    }
}
    </script>
</body>
</html>
